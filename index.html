<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Hyoukomi's Boss Roulette</title>
<link href="https://fonts.googleapis.com/css2?family=Cherry+Bomb+One&family=Quicksand:wght@300..700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="style.css">
</head>
<body>

<div id="main-header-title-wrapper">
    <div id="title-icon-placeholder"></div>
    <h1 id="page-title">Hyoukomi's Boss Roulette üå∏</h1>
</div>

<button id="btn-reset-all" onclick="resetEntireGame()">Restart game</button>

<div class="full-width-boons-wrapper">
    <div class="boons-selector card">

        <div class="boon-toggle-header" onclick="toggleBoonsDropdown()">
            <h2>Selectable Boons<span id="toggle-icon">></span></h2>
        </div>

        <div id="boon-list-master-wrapper" style="max-height: 0; overflow: hidden; transition: max-height 0.4s ease-out;">
            <div class="boon-list-container" id="boon-list-master">
                </div>
        </div>

        <div id="active-boons-list" style="margin-top: 20px; padding: 10px; border-top: 1px solid #0a3a7c; font-style: italic; color: #0a3a7c; font-size: 0.9em;">
            <p style="margin: 0;"><strong>Active Boons:</strong> None selected.</p>
        </div>
        
        <div class="button-group" style="justify-content: center; margin-top: 15px; padding: 0 10px 10px 10px;">
            <button class="btn-primary" id="btn-activate-boon" onclick="handleBoonActivation()" disabled>Activate Selected Boon</button>
        </div>
        </div>
</div>
<div class="page-layout">

<div class="left-column card">
    <p>Step 1: </p>
    <div class="exclusion-generator" style="margin-top: 0;"> <h2>Character Bans</h2>
        <div class="control-group" style="justify-content: flex-start; margin-bottom: 20px;">
            <label for="exclusion-count-input" style="font-weight: bold;">Number of character bans:</label>
            <input type="number" id="exclusion-count-input" value="6" min="1" max="99" style="width: 50px; padding: 5px; border-radius: 4px; background-color: rgba(255, 192, 203, 0.4); border: 1px solid #0a3a7c; border: 1px solid #0a3a7c; text-align: center; color: #0a3a7c;">
        </div>
        <div id="exclusion-list">
        <p style="color: #0a3a7c; font-weight: normal;">Enter the number of characters to ban.</p>
        </div>
        <div class="button-group" style="justify-content: flex-start; margin-top: 10px; margin-bottom: 0;">
            <button class="btn-tertiary-blue" id="btn-generate-exclusions" onclick="handleGenerateExclusions()">Generate character bans</button>
            <button class="btn-secondary" id="btn-unban-selected" onclick="handleUnbanSelected()" style="display: none;">Unban Selected</button>
        </div>
    </div>
    
    <div class="category-ban-randomizer" style="margin-top: 30px;">
        <p>Step 2: </p>
        <h2>Category Ban</h2>
        <div id="category-ban-display" style="margin-bottom: 25px;">Roll to determine Character or Boss Bans.</div>
        <div style="text-align: left; margin-bottom: 30px;">
        <button class="btn-secondary" id="btn-roll-ban-category" onclick="runCategoryBan()">Roll Ban Category</button>
        </div>

        <h3>Boss Ban List</h3>
        <div id="boss-ban-list">
        <p style="color: #0a3a7c; font-weight: normal;">No bosses currently banned.</p>
        </div>
        <p id="boss-pool-status" style="font-size: 0.9em; margin-top: 10px; color: #0a3a7c; font-weight: bold;">Total Bosses Available: 50</p>
    </div>
</div>

<div class="sidebar card">
<h2>Death Penalty</h2>
<div class="score-info">
<span id="score-current">Current: 0</span>
<span id="score-max"></span>
</div>
<hr style="display: none;"/>

<h2>Bosses rolled this cycle: </h2>
<ol id="rolled-list">
<li>No bosses rolled yet.</li>
</ol>
</div>


<div class="boss-randomizer card">
<h1>Boss Roulette Game Start</h1>

<div class="controls-area">
<div class="control-group">
<label for="boss-rotation-input" style="font-weight: bold;">Rotation Size: </label>
<input type="number" id="boss-rotation-input" value="12" min="1" max="50" onchange="updateScoreDisplay()">
</div>
<div class="control-group">
<label style="font-weight: bold;">Status:</label>
<span id="rotation-status">0/12 bosses done</span>
</div>
</div>

<div id="boss-display">
<h2 id="boss-name">Roll a boss to begin the rotation!</h2>
<div id="parameters-area" style="width: 100%;">
</div>
</div>

<div class="scoring-section" id="scoring-area">
<h2>How many of you threw?</h2>
<p>Select how many people died for this boss.</p>
<div class="score-controls">
<label><input type="radio" name="penalty_score" value="0" checked> 0</label>
<label><input type="radio" name="penalty_score" value="1"> 1</label>
<label><input type="radio" name="penalty_score" value="2"> 2</label>
<label><input type="radio" name="penalty_score" value="3"> 3</label>
<label><input type="radio" name="penalty_score" value="4"> 4</label>
<label><input type="radio" name="penalty_score" value="5"> 5</label>
<label><input type="radio" name="penalty_score" value="6"> 6</label>
<label><input type="radio" name="penalty_score" value="7"> 7</label>
<label><input type="radio" name="penalty_score" value="8"> 8</label>
</div>
</div>

<div class="button-group" id="roll-button-group">
    <div class="control-group" style="gap: 5px; flex-shrink: 0; align-self: center;"> 
        <label for="boss-roll-count" style="font-size: 0.9em; font-weight: bold; color: #0a3a7c;">Roll Count:</label>
        <input type="number" id="boss-roll-count" value="1" min="1" max="12" style="width: 40px; padding: 5px; border-radius: 4px; background-color: rgba(255, 192, 203, 0.4); border: 1px solid #0a3a7c; text-align: center; color: #0a3a7c;">
    </div>
    <button class="btn-primary" id="btn-roll-next" onclick="handleBossRoll()">Roll Next Boss / Log Run</button>
    <button class="btn-secondary" id="btn-quick-reroll" onclick="rerollBoss()" style="display: none;">Quick Reroll</button>
</div>
<button class="btn-reset" id="btn-reset-reroll" onclick="resetRotationAndReroll()">Reset Rotation & Reroll Boss</button>
<p style="margin-top: 25px; margin-bottom: 0; font-size: 0.9em; color: #0a3a7c; text-align: center;"> *The next roll will automatically log the status of the previously rolled boss using the selected penalty score. </p>
</div>

<div class="full-width-character-selector card">
<h1>Genshin Character Randomizer</h1>
<div class="character-randomizer">
<h2>‚ú® 8 Character Randomizer</h2>
<div id="character-display">
<p>Click "Roll Characters" to generate 8 characters. Select all 8 characters for regular runs and the 4 used for Omniscient runs.</p>
</div>
<p id="selection-message">You must select at least 4 characters used before confirming.</p>
<div id="current-pool-status" style="text-align: center; font-weight: bold; margin-bottom: 15px; color: #0a3a7c;">Total Characters Available: 99</div>
<div class="button-group" style="margin-top: 0; margin-bottom: 15px;">
<button class="btn-tertiary" id="btn-roll-chars" onclick="randomizeCharacters(8)">Roll Characters</button>
<button class="btn-secondary" id="btn-reroll-chars" onclick="rerollCharacters()" style="display: none;">Reroll Characters</button>
<button class="btn-primary" id="btn-confirm-usage" onclick="confirmUsedCharacters()">Confirm selected as used characters</button>
</div>
<div style="text-align: center;">
<button class="btn-reset" onclick="resetCharacterLists()">Reset Character Pool</button>
</div>
</div>
</div>


</div> <div id="final-score-modal" class="modal-overlay">
<div class="modal-content">
<h2 style="margin-bottom: 10px;">Rotation Complete!</h2>
<p>You have finished the challenge rotation.</p>
<div id="modal-score-details">
<p>Death count: <span id="modal-score-current">0</span></p>
<p style="margin-top: 5px;">Ignore this lol <span id="modal-score-max">48</span></p>
<h3 id="modal-score-percentage"></h3>
</div>
<button id="modal-confirm-button" class="btn-primary" onclick="closeFinalScoreModal()">Confirm & Start New Game</button>
</div>
</div>

<script>
// Global state tracking
let rolledBosses = [];
let lastRerolledBoss = null;
let currentBossToLog = null;
let currentScore = 0; 
// Character squad state
let currentRolledSquad = [];
let activeBoons = []; // STATE TRACKER for boons
// NEW STATE: Track uses for activatable/consumable boons
let boonActivationUses = {}; 

// NEW STATE TRACKERS for setup control
let isExclusionGenerated = false; // Only one state tracker needed now

// Boss Pool State
let bossesOriginal = [];
let bossPool = [];
const bossBanList = [];

// Character Pool State
let characterPool = [];
const exclusionList = [];

// --- DATA ARRAYS (Definitions) ---
const initialBosses = [
// Bosses list remains unchanged
{ name: "Geo Hypostasis", description: "Requires at least one Sword, Claymore or Polearm character" },
{ name: "Pyro Hypostasis", description: "Requires at least one Hydro or Cryo character" },
{ name: "Dendro Hypostasis", description: "Requires at least one Dendro or Hydro character" },
{ name: "SSA: Configuration Device", description: "Requires characters capable of height ascension" },
{ name: "Wayward Hermetic Spiritspeaker", description: "Requires at least one Pyro or Electro character" },
{ name: "SSA: Overseer Device", description: "Requires at least one character capable of high-frequency Cryo application" },
{ name: "Joururi Workshop (Scaramouche Boss)", description: "Requires at least one character capable of interacting with and destroying the Nirvana Engine" },
{ name: "Unresolved Chess Game", description: "Requires at least one Hydro and Cryo character" },
{ name: "The Knave - Arlecchino", description: "Requires at least one character capable of healing self and others" },
{ name: "Anemo Hypostasis", description: null },
{ name: "Cryo Hypostasis", description: null },
{ name: "Cryo Regisvine", description: null },
{ name: "Electro Hypostasis", description: null },
{ name: "Oceanid", description: null },
{ name: "Primo Geovishap", description: null }, 
{ name: "Pyro Regisvine", description: null },
{ name: "Ruin Serpent", description: null },
{ name: "Solitary Suanni", description: null },
{ name: "Bathysmal Vishap Herd", description: null },
{ name: "Golden Wolflord", description: null },
{ name: "Hydro Hypostasis", description: null },
{ name: "Maguu Kenki", description: null },
{ name: "Perpetual Mechanical Array", description: null },
{ name: "Thunder Manifestation", description: null },
{ name: "Shroom Chicken", description: null },
{ name: "Electro Regisvine", description: null },
{ name: "Aeonblight Drake", description: null },
{ name: "Dorito", description: null },
{ name: "Setekh Wenut", description: null },
{ name: "Iniquitous Baptist", description: null },
{ name: "Icewind Suite", description: null },
{ name: "Emperor of Fire and Iron", description: null },
{ name: "Experimental Field Generator", description: null },
{ name: "Millennial Pearl Seahorse", description: null },
{ name: "Hydro Tulpa", description: null },
{ name: "Legatus Golem", description: null },
{ name: "Goldflame Qucusaur Tyrant", description: null },
{ name: "CaseOH", description: null },
{ name: "Radiant Moonfly", description: null },
{ name: "Knuckle Duckle", 
description: null },
{ name: "Lupus Boreas", description: null },
{ name: "Childe", description: null },
{ name: "Azhdaha", description: null },
{ name: "La Signora", description: null },
{ name: "Raiden Shogun", description: null },
{ name: "Guardian of Apep's Oasis", description: null },
{ name: "All-Devouring Narwhal", description: null },
{ name: "Lord of Eroded Primal Fire", description: null },
{ name: "Lava Dragon Statue", description: null },
{ name: "Frostnight Herra", description: null },
{ name: "Super-Heavy Landrover: Mechanized Fortress", description: null }
];
const characters = [
"Jahoda", "Durin", "Traveler", "Aloy", "Bennett", "Chevreuse", "Dehya", "Diluc", "Hu Tao", "Gaming", "Klee", "Lyney", "Thoma", "Mavuika", "Xiangling", "Xinyan", "Yanfei", "Yoimiya", "Amber", "Arlecchino", "Albedo", "Arrataki Itto", "Chiori", "Kachina", "Ningguang", "Noelle", "Xilonen", "Yunjin", "Zhongli", "Gorou", "Navia", "Ayato", "Childe", "Aino", "Candace", "Furina", "Kokomi", "Mualani", "Mona", "Nilou", "Neuvilette", "Sigewinne", "Xingqiu", "Yelan", "Dahlia", "Barbara", "Baizhu", "Collei", "Kinich", "Kaveh", "Kirara", "Lauma", "Tighnari", "Emilie", "Nefer", "Yao Yao", "Alhaitham", "Nahida", "Cyno", "Dori", "Fischl", "Beidou", "Iansan", "Ororon", "Keqing", "Ineffa", "Lisa", "Kuki Shinobu", "Kujou Sara", "Raiden Shogun", "Razor", "Rosaria", "Flins", "Sethos", "Varesa", "Yae Miko", "Wanderer", "Clorinde", "Charlotte", "Ayaka", "Chongyun", "Citlali", "Diona", "Escoffier", "Kaeya", "Layla", "Eula", "Mika", "Wriothesley", "Freminet", "Shenhe", "Skirk", 
"Qiqi", "Ganyu", "Chasca", "Faruzan", "Heizou", "Lan yan", "Ifa", "Jean", "Kazuha", "Lynette", "Sayu", "Mizuki", "Sucrose", "Venti", "Xianyun", "Xiao"
];

// --- DATA: 4-STAR CHARACTERS FOR "FOUR-STAR IMPACT" BOON (IMPLEMENTED) ---
const FOUR_STAR_CHARS = [
    "Aino", "Amber", "Barbara", "Beidou", "Bennett", "Candace", "Charlotte", "Chevreuse", 
    "Chongyun", "Collei", "Dahlia", "Diona", "Dori", "Faruzan", "Fischl", "Freminet", 
    "Gaming", "Gorou", "Iansan", "Ifa", "Kachina", "Kaeya", "Kazuha", "Kaveh", "Kirara", "Kuki Shinobu", "Kujou Sara", 
    "Lan yan", "Layla", "Lisa", "Lynette", "Mika", "Ningguang", "Noelle", 
    "Ororon", "Razor", "Rosaria", "Sayu", "Sethos", "Heizou", "Sucrose", "Thoma", 
    "Xiangling", "Xingqiu", "Xinyan", "Yanfei", "Yao Yao", 
    "Yunjin", "Thoma", "Jahoda"
];

// NEW DATA: Manually classified 5-star characters for boon logic (based on the full 'characters' list)
const fiveStarCharacters = [
    "Durin", "Dehya", "Diluc", "Hu Tao", "Klee", "Lyney", "Yoimiya", "Arlecchino", "Albedo", 
    "Arrataki Itto", "Chiori", "Zhongli", "Navia", "Ayato", "Childe", "Furina", "Kokomi", 
    "Mualani", "Mona", "Nilou", "Neuvilette", "Sigewinne", "Yelan", "Baizhu", "Tighnari", 
    "Alhaitham", "Nahida", "Cyno", "Keqing", "Raiden Shogun", "Yae Miko", "Wanderer", 
    "Clorinde", "Ayaka", "Eula", "Wriothesley", "Shenhe", "Qiqi", "Ganyu", "Jean", 
    "Kazuha", "Venti", "Xianyun", "Xiao", "Xilonen", "Kinich", "Lauma", "Emilie", "Nefer", "Ineffa", "Flins", "Varesa", "Citlali", "Escoffier", "Skirk", "Chasca", "Mizuki", "Mavuika", "Aloy", "Traveler"
];
// ----------------------------------------------------------------------
const BOONS_DATA = [
    // Standard Boons
    { id: "boon-delete", name: "Delete Button", type: "Standard", description: 'Use this at any point in the session to "insta-kill" an upcoming boss. Characters rolled for the "insta-killed" boss will still be cycled out, and the boss will be counted as a clear.' },
    { id: "boon-starless", name: "Starless, Peerless Night", type: "Standard", description: 'Using 5-star characters with active constellations will contribute to the Death Count, dependent on the 5-star character constellation level. When reaching the final boss, all characters will be brought back from elimination, with all and any character available to use. 2x Roulette EXP upon clearing.' },
    { id: "boon-boomerang", name: "Boomerang Effect", type: "Standard", description: 'Bosses will no longer cycle out of the Boss Wheel for the session.' },
    { id: "boon-reckless", name: "Don‚Äôt Be Reckless!", type: "Standard", description: 'When two deaths occur in a boss fight, it is considered a wipe; however, all wipes in this session will not contribute to run failure except for wipes on the final boss.' },
    { id: "boon-doubledown", name: "Double Down", type: "Standard", description: 'For Character Ban Phases, this will ban an additional 8 characters and decrease the session\'s bosses to 11.' },
    { id: "boon-duplicate", name: "Duplication Method", type: "Standard", description: 'On the final boss, duplicate characters may be used.' },
    { id: "boon-combo", name: "Fast Food Combo Meal", type: "Standard", description: 'Combines both the Boss and Character Ban Phase for the session.' },
    { id: "boon-fourstar", name: "Four-Star Impact", type: "Standard", description: 'Character cycling will only cycle out 5-star characters for the session.' },
    { id: "boon-highpotential", name: "High Potential", type: "Standard", description: 'In Boss Ban Phases, increases the maximum in the original RNG values to 35. The Boss Ban Phase will behave in a manner where up to 35 bosses will be banned for the session.' },
    { id: "boon-contraband", name: "Illegal Contraband", type: "Standard", description: 'Enables Gadget usage and environmental mechanisms within boss fights.' },
    { id: "boon-keyhidden", name: "Key To a Hidden Stage", type: "Standard", description: 'After clearing the final boss, the team will have the option to fight the "Tenebrous Papilla" boss. Clearing this additional boss will give you +50 additional Komishells. Deaths/Wipes on this boss will not count against your run.' },
    { id: "boon-lifeinsurance", name: "Life Insurance", type: "Standard", description: 'When collecting twelve total defeated boss drops within a session as a team, it reverts all current Team Wipe Lives to zero.' },
    { id: "boon-moneyback", name: "Money-Back Guarantee", type: "Standard", description: 'If at least 6 weekly bosses in the session are defeated, 2 eliminated characters can be brought back into the Character Randomizer pool based on player choice.' },
    { id: "boon-moonlit", name: "Moonlit Sanctuary", type: "Standard", description: 'Automatically reroll character results when Nod-Krai characters are not rolled with at least one Hydro character. This will not affect the run\'s Pristine status if applicable.' },
    { id: "boon-nochilde", name: "No ‚ÄúChilde‚Äù Policy", type: "Standard", description: 'Guarantees the character "Tartaglia" to be banned in the Initial Character Ban Phases. Guarantees the "Childe" weekly boss to be banned in Boss Ban Phases.' },
    { id: "boon-nonlinear", name: "Non-Linear", type: "Standard", description: 'At the start of the session, rolls all of the session‚Äôs bosses simultaneously. Bosses may be dealt with in any order by player choice.' },
    { id: "boon-notvariable", name: "Not a Variable", type: "Standard", description: 'One random character will remain constant in the Character Randomizer, never being eliminated.' },
    { id: "boon-hardship", name: "Personal Hardship Investment", type: "Standard", description: 'Automatically takes effect in your next session. Those with this boon\'s ownership will fail the entire session if they are defeated once within boss fights. Upon clear, gain 2x Roulette EXP, and this boon becomes a Legendary Boon.' },
    { id: "boon-pretend", name: "Playing Pretend", type: "Standard", description: 'Enables Starlight Resonance - Level 4 to be in effect for the run, regardless of player Unbroken Standing.' },
    { id: "boon-regeneration", name: "Regeneration Module", type: "Standard", description: 'The Death Count will gradually decay over time back to zero. For every 3 boss defeats, 1 point will be taken from the Death Count.' },
    { id: "boon-secondwinds", name: "Second Winds", type: "Standard", description: 'For the session, the team will obtain 3 revive tokens that can be used at any time. Deaths will still contribute to the Death Count.' },
    { id: "boon-highnote", name: "Starting On a High Note", type: "Standard", description: 'The first three bosses in the session are guaranteed to be Azhdaha, Unresolved Chess Game and Lord of Eroded Primal Fire in order. After clearing these bosses, all weekly boss results will be skipped. Gain double Roulette EXP.' },
    { id: "boon-surprise", name: "Surprise Guest", type: "Standard", description: 'Adds one random Local Legend into the Boss Wheel. Defeating the Local Legend will award +50 Komishells and +100 Roulette EXP upon run clear.' },
    { id: "boon-sync", name: "Synchronization Module", type: "Standard", description: 'If a boss is defeated using characters of the same element or region, the Death Count is reduced by 1 point.' },
    { id: "boon-inevitable", name: "The Inevitable", type: "Standard", description: 'The final boss will be guaranteed to be Lord of Eroded Primal Fire, regardless of whether this boss was rolled and defeated/wiped upon previously. Gain double Roulette EXP upon clear.' },
    { id: "boon-wonderland", name: "Wonderland Stage", type: "Standard", description: 'Character use is restricted to Manekin/Manekina only for the session. All weekly boss results will be skipped. Gain double Roulette EXP upon clear.' },

    // Legendary Boons
    { id: "boon-saw-nothing", name: "‚ÄùWe saw nothing. Carry on!‚Äù (Legendary)", type: "Legendary", description: 'The first four deaths to occur in the session will not count towards the run\'s Death Count.' },
    { id: "boon-delicious-meal", name: "A Delicious Meal (Legendary)", type: "Legendary", description: 'Non-healing consumables may be used for the entire session (All ATK, Crit, HP, Stamina food buffs).' },
    { id: "boon-jasmine", name: "Jasmine‚Äôs Blessing (Legendary)", type: "Legendary", description: 'Use this at any point in the session to trade places with Jasmine to clear the boss. Jasmine will utilize her C6R5 Chasca for the fight regardless of the rolled result. When the boss is either cleared or wiped upon, Jasmine will exit and trade places with the wielder of this boon.' },
    { id: "boon-premium-spin", name: "Premium Spin Club Free Trial (Legendary)", type: "Legendary", description: 'At the start of the session, gain 2 additional reroll tokens. Defeating weekly bosses grants the team +1 reroll token. Using reroll tokens will not count against the run\'s Pristine status and will not dock points.' },
    { id: "boon-priscilla", name: "Priscilla‚Äôs Blessing (Legendary)", type: "Legendary", description: 'When this boon is active, and the run is a Flawless clear or higher, all party members will gain an additional +1,000 Komishells, +1,000 Roulette EXP, and +50 Unbroken Standing.' }
];
// ----------------------------------------------------------------------
const CHAR_IMAGE_MAP = {
    "Jahoda": "images/jahoda.png", "Durin": "images/durin.png","Aino": "images/aino.png", "Albedo": "images/albedo.png", "Alhaitham": "images/alhaitham.png", "Aloy": "images/alloy.png", "Amber": "images/amber.png", "Arlecchino": "images/arlecchino.png", "Arrataki Itto": "images/itto.png", "Ayaka": "images/ayaka.png", "Ayato": "images/ayato.png", "Baizhu": "images/baizhu.png", "Barbara": "images/barbara.png", "Beidou": "images/beidou.png", "Bennett": "images/bennett.png", "Candace": "images/candace.png", "Chasca": "images/chasca.png", "Charlotte": "images/charlotte.png", "Chevreuse": "images/chevreuse.png", "Childe": "images/tartaglia.png", "Chiori": "images/chiori.png", "Chongyun": "images/chongyun.png", "Citlali": "images/citlali.png", "Clorinde": "images/clorinde.png", "Collei": "images/collei.png", "Cyno": "images/cyno.png", "Dahlia": "images/dahlia.png", "Dehya": "images/dehya.png", "Diluc": "images/diluc.png", "Diona": "images/diona.png", "Dori": "images/dori.png", "Emilie": "images/emilie.png", "Escoffier": "images/escoffier.png", "Eula": "images/eula.png", "Faruzan": "images/faruzan.png", "Fischl": "images/fischl.png", "Flins": "images/flins.png", "Freminet": "images/freminet.png", "Furina": "images/furina.png", "Gaming": "images/gaming.png", "Ganyu": "images/ganyu.png", "Gorou": "images/gorou.png", "Heizou": "images/heizou.png", "Hu Tao": "images/hutao.png", "Iansan": "images/iansan.png", "Ifa": "images/ifa.png", "Ineffa": "images/ineffa.png", "Jean": "images/jean.png", "Kachina": "images/kachina.png", "Kaeya": "images/kaeya.png", "Kazuha": "images/kazuha.png", "Kaveh": "images/kaveh.png", "Keqing": "images/keqing.png", "Kinich": "images/kinich.png", "Kirara": "images/kirara.png", "Klee": "images/klee.png", "Kokomi": "images/kokomi.png", "Kuki Shinobu": "images/kukishinobu.png", "Kujou Sara": "images/sara.png", "Lauma": "images/lauma.png", "Lan yan": "images/lanyan.png", "Layla": "images/layla.png", "Lisa": "images/lisa.png", "Lyney": "images/lyney.png", "Lynette": "images/lynette.png", "Mavuika": "images/mavuika.png", "Mika": "images/mika.png", "Mizuki": "images/mizuki.png", "Mona": "images/mona.png", "Mualani": "images/mualani.png", "Nahida": "images/nahida.png", "Navia": "images/navia.png", "Nefer": "images/nefer.png", "Neuvilette": "images/neuvilette.png", "Nilou": "images/nilou.png", "Ningguang": "images/ningguang.png", "Noelle": "images/noelle.png", "Ororon": "images/ororon.png", "Qiqi": "images/qiqi.png", "Raiden Shogun": "images/raiden.png", "Razor": "images/razor.png", "Rosaria": "images/rosaria.png", "Sayu": "images/sayu.png", "Sethos": "images/sethos.png", "Shenhe": "images/shenhe.png", "Sigewinne": "images/sigewinne.png", "Skirk": "images/skirk.png", "Sucrose": "images/sucrose.png", "Thoma": "images/thoma.png", "Tighnari": "images/tighnari.png", "Traveler": "images/traveler.png", "Varesa": "images/varesa.png", "Venti": "images/venti.png", "Wanderer": "images/wanderer.png", "Wriothesley": "images/wriothesley.png", "Xiao": "images/xiao.png", "Xianyun": "images/xianyun.png", "Xiangling": "images/xiangling.png", "Xilonen": "images/xilonen.png", "Xingqiu": "images/xingqiu.png", "Xinyan": "images/xinyan.png", "Yae Miko": "images/yaemiko.png", "Yanfei": "images/yanfei.png", "Yao Yao": "images/yaoyao.png", "Yelan": "images/yelan.png", "Yoimiya": "images/yoimiya.png", "Yunjin": "images/yunjin.png", "Zhongli": "images/zhongli.png", "DEFAULT_PATH": "images/placeholder.png" 
};

function renderBoons() {
    // Get the master container (which is now the vertical stack parent)
    const masterContainer = document.getElementById('boon-list-master');
    masterContainer.innerHTML = ''; // Clear contents
    
    // Create the Boon Groups (the vertical stacks)
    const standardGroup = document.createElement('div');
    standardGroup.className = 'boon-group standard-group';
    standardGroup.innerHTML = '<h3>Standard Boons</h3>';

    const legendaryGroup = document.createElement('div');
    legendaryGroup.className = 'boon-group legendary-group';
    legendaryGroup.innerHTML = '<h3>Legendary Boons</h3>';

    BOONS_DATA.forEach(boon => {
        const itemDiv = document.createElement('div');
        itemDiv.className = `boon-item ${boon.type.toLowerCase()}-boon`;

        const input = document.createElement('input');
        input.type = 'checkbox';
        input.id = boon.id;
        input.name = 'boon';
        input.value = boon.name;
        // Check if boon is active and set checkbox state
        if (activeBoons.includes(boon.name)) {
            input.checked = true;
        }
        input.onchange = handleBoonChange;

        const label = document.createElement('label');
        label.htmlFor = boon.id;
        label.textContent = boon.name;

        const description = document.createElement('p');
        description.className = 'boon-description';
        description.textContent = boon.description;

        itemDiv.appendChild(input);
        itemDiv.appendChild(label);
        itemDiv.appendChild(description);

        if (boon.type === 'Standard') {
            standardGroup.appendChild(itemDiv);
        } else {
            legendaryGroup.appendChild(itemDiv);
        }
    });

    // Append the groups directly to the vertical container
    masterContainer.appendChild(standardGroup);
    masterContainer.appendChild(legendaryGroup);

    // Initial call to update the active boons list
    handleBoonChange();
}

/**
 * Updates the active boons state and the display message, and sets up activation uses.
 */
function handleBoonChange() {
    activeBoons = [];
    boonActivationUses = {}; // Reset uses
    const checkboxes = document.querySelectorAll('input[name="boon"]:checked');
    checkboxes.forEach(checkbox => {
        const boonName = checkbox.value;
        activeBoons.push(boonName);
        
        // Check for activatable/consumable boons and set initial uses (1 per session)
        if (boonName === "Delete Button" || boonName === "Jasmine‚Äôs Blessing (Legendary)") {
            boonActivationUses[boonName] = 1;
        }
    });

    const listElement = document.getElementById('active-boons-list').querySelector('p');
    if (activeBoons.length > 0) {
        listElement.innerHTML = `<strong>Active Boons (${activeBoons.length}):</strong> ${activeBoons.join(', ')}`;
    } else {
        listElement.innerHTML = '<strong>Active Boons:</strong> None selected.';
    }
    
    // Update activation button text/state
    updateBoonActivationButton(); 
}

/**
 * Updates the state and text of the Activate Boon button.
 */
function updateBoonActivationButton() {
    const button = document.getElementById('btn-activate-boon');
    const activatableBoons = Object.keys(boonActivationUses).filter(key => boonActivationUses[key] > 0);
    
    if (activatableBoons.length === 1) {
        // Show the first word of the boon's name (e.g., "Delete")
        button.textContent = `Activate Boon: ${activatableBoons[0].split(' ')[0]}`;
        button.disabled = false;
    } else if (activatableBoons.length > 1) {
        button.textContent = `Activate 1 of ${activatableBoons.length} Boons`;
        button.disabled = false;
    } else {
        button.textContent = 'Activate Selected Boon';
        button.disabled = true; // No activatable boon selected or available
    }
}


function handleBoonActivation() {
    // 1. Check game state prerequisites
    if (!isExclusionGenerated) {
        alert("Please complete the setup in the left column first: Generate Exclusions.");
        return;
    }
    if (!currentBossToLog) {
        alert("You must roll a boss first before activating a boon.");
        return;
    }
    const rotationSize = parseInt(document.getElementById('boss-rotation-input').value);
    if (rolledBosses.length >= rotationSize) {
        alert("Rotation is already complete.");
        return;
    }

    // 2. Identify available activatable boons
    const activatableBoons = Object.keys(boonActivationUses).filter(key => boonActivationUses[key] > 0);

    if (activatableBoons.length === 0) {
        alert("No activatable boons are currently available. Please select one or ensure its use hasn't been exhausted.");
        return;
    }

    let boonToActivate;

    // 3. Handle selection if multiple boons are available (simple prompt for now)
    if (activatableBoons.length > 1) {
        const boonNames = activatableBoons.map((name, index) => `${index + 1}: ${name}`).join('\n');
        const choice = prompt(`Select a boon to activate by entering the number:\n${boonNames}`);
        const choiceIndex = parseInt(choice) - 1;
        
        if (isNaN(choiceIndex) || choiceIndex < 0 || choiceIndex >= activatableBoons.length) {
            alert("Invalid selection. Activation cancelled.");
            return;
        }
        boonToActivate = activatableBoons[choiceIndex];
    } else {
        boonToActivate = activatableBoons[0];
    }
    
    // 4. Apply Boon Effect
    let success = false;
    let effectMessage = "";
    let confirmTitle = "";
    
    // Get the boon description for the pop-up
    const fullBoonData = BOONS_DATA.find(b => b.name === boonToActivate);

    if (boonToActivate === "Delete Button") {
        // Log the current boss as cleared with 0 score
        currentScore += 0;
        // UPDATED: Changed 4 to 8
        const bossEntry = `[Score 0/8] ${currentBossToLog} (Cleared with Delete Button)`;
        rolledBosses.push(bossEntry);

        confirmTitle = `Boon Activated: ${boonToActivate}`;
        effectMessage = `The boss **${currentBossToLog}** has been "insta-killed" and logged as a clear (0 penalty). A new boss has been rolled.`;
        success = true;

    } else if (boonToActivate === "Jasmine‚Äôs Blessing (Legendary)") {
        // Log the current boss as cleared with 0 score (Implicit clear)
        currentScore += 0;
        // UPDATED: Changed 4 to 8
        const bossEntry = `[Score 0/8] ${currentBossToLog} (Cleared with Jasmine's Blessing)`;
        rolledBosses.push(bossEntry);

        confirmTitle = `Legendary Boon Activated: ${boonToActivate}`;
        effectMessage = `Jasmine has traded places and cleared **${currentBossToLog}** (0 penalty). A new boss has been rolled.`;
        success = true;
    }
    
    // 5. Finalize Activation
    if (success) {
        boonActivationUses[boonToActivate] = 0; // Consume the use
        currentBossToLog = null; // Mark current boss as logged/cleared
        
        // Immediately roll the next boss
        handleNextBossRollAfterActivation();

        // Update UI
        updateRolledList();
        updateScoreDisplay();
        updateStatus(rotationSize);
        updateBoonActivationButton(); // Update button state
        
        // **NEW: Show Confirmation Pop-up**
        const alertContent = `${confirmTitle}\n\nEffect: ${fullBoonData.description}\n\nOutcome: ${effectMessage}`;
        alert(alertContent);
    }
}


function handleNextBossRollAfterActivation() {
    const rotationSize = parseInt(document.getElementById('boss-rotation-input').value);
    
    // 1. Check if rotation is complete after logging the boon-cleared boss
    if (rolledBosses.length >= rotationSize) {
        updateCurrentBossDisplay(null); // Clears display and shows "Rotation Complete!"
        showFinalScoreModal(rotationSize);
        document.getElementById('btn-quick-reroll').style.display = 'none';
        document.getElementById('btn-roll-next').textContent = 'Boss beaten!';
        document.getElementById('btn-roll-next').disabled = true;
        return;
    }

    // 2. Roll the next boss
    const nextBoss = rollBossSingle(); 

    if (nextBoss) {
        currentBossToLog = nextBoss.name;
        updateCurrentBossDisplay(nextBoss);
        // Ensure button text is correct
        document.getElementById('btn-roll-next').textContent = 'Roll Next Boss';
    } else {
         // If pool was empty
         updateCurrentBossDisplay(null); 
         document.getElementById('btn-roll-next').textContent = 'Boss defeated!';
         document.getElementById('btn-roll-next').disabled = true;
    }
}


/**
 * Toggles the visibility of the boon list.
 */
function toggleBoonsDropdown() {
    const wrapper = document.getElementById('boon-list-master-wrapper');
    const icon = document.getElementById('toggle-icon');
    
    // Check current state (using the inline style set on the wrapper)
    if (wrapper.style.maxHeight === '0px' || wrapper.style.maxHeight === '') {
        // Open the dropdown
        wrapper.style.maxHeight = wrapper.scrollHeight + "px";
        icon.textContent = '‚ñ≤'; // Change icon to up arrow
    } else {
        // Close the dropdown
        wrapper.style.maxHeight = '0';
        icon.textContent = '‚ñº'; // Change icon to down arrow
    }
}
// --- END BOON LOGIC ---


// --- SCOREBOARD UTILITIES (MODIFIED) ---
function updateScoreDisplay() {
const rotationInput = document.getElementById('boss-rotation-input');
const rotationSize = parseInt(rotationInput.value);
// UPDATED: Changed 4 to 8
const maxPossibleScore = rotationSize * 8;
document.getElementById('score-max').textContent = ` `;
document.getElementById('score-current').textContent = `Current number of deaths: ${currentScore}`;
}
function updateRolledList() {
const listElement = document.getElementById('rolled-list');
listElement.innerHTML = '';
if (rolledBosses.length === 0) {
listElement.innerHTML = '<li>No bosses rolled yet.</li>';
return;
}
rolledBosses.forEach(bossEntry => {
const listItem = document.createElement('li');
listItem.textContent = bossEntry;
listElement.appendChild(listItem);
});
}


// --- BOSS POOL MANAGEMENT (UNCHANGED) ---

function updateBossPoolStatus() {
document.getElementById('boss-pool-status').textContent = `Total Bosses Available: ${bossPool.length}`;
}

function getBossObjectByName(bossName) {
// We search the full original list to find the object since the bossPool array might be modified by bans
return bossesOriginal.find(boss => boss.name === bossName);
}

function updateBossPool(namesToRemove) {
bossPool = bossPool.filter(boss => !namesToRemove.includes(boss.name));
updateBossPoolStatus();
}

/**
 * Renders the bossBanList as an unordered (bulleted) list.
 */
function displayBossBanList() {
    const listContainer = document.getElementById('boss-ban-list');
    listContainer.innerHTML = '';
    
    if (bossBanList.length === 0) {
        listContainer.innerHTML = '<p style="color: #0a3a7c; font-weight: normal;">No bosses currently banned.</p>';
        return;
    }

    // Create the bulleted list (<ul>)
    const ul = document.createElement('ul');

    bossBanList.forEach(name => {
        // Create the list item (<li>) for each boss
        const listItem = document.createElement('li');
        listItem.textContent = name;
        ul.appendChild(listItem);
    });

    listContainer.appendChild(ul);
}

function resetBossPool() {
// This function is ONLY for the full game reset (clears all bans)
bossPool = [...initialBosses];
bossBanList.length = 0;
updateBossPoolStatus();
displayBossBanList();
}

// --- CATEGORICAL BAN RANDOMIZER LOGIC (UNCHANGED) ---

function runCategoryBan() {
    // PREREQUISITE CHECK - Only need exclusion to be generated
    if (!isExclusionGenerated) {
        alert("Please generate the Initial Character Exclusion List first.");
        return;
    }

    const banType = Math.random() < 0.5 ? 'Boss Bans' : 'Character Bans';
    const display = document.getElementById('category-ban-display');

    if (banType === 'Boss Bans') {
        // NEW LOGIC: Ban a random amount of bosses 10 to 20.
        const minBan = 10;
        const maxBan = 20; 
        // Calculate a random number between minBan (inclusive) and maxBan (inclusive)
        const numToBan = Math.floor(Math.random() * (maxBan - minBan + 1)) + minBan;
        
        // Ensure we don't try to ban more than available bosses
        const bossesToBan = [];
        const poolForBan = bossPool.filter(boss => !bossBanList.includes(boss.name));
        if (poolForBan.length === 0) {
            display.textContent = "Ban: Bosses. (No bosses left to ban!)";
        } else {
            const actualNumToBan = Math.min(numToBan, poolForBan.length);

            while (bossesToBan.length < actualNumToBan) {
                const randomIndex = Math.floor(Math.random() * poolForBan.length);
                const boss = poolForBan.splice(randomIndex, 1)[0];
                if (!bossBanList.includes(boss.name)) {
                    bossesToBan.push(boss.name);
                    bossBanList.push(boss.name);
                }
            }
            
            // Apply "No ‚ÄúChilde‚Äù Policy" boon effect for Childe boss ban
            if (activeBoons.includes("No ‚ÄúChilde‚Äù Policy") && !bossBanList.includes("Childe")) {
                const childeBoss = getBossObjectByName("Childe");
                if (childeBoss) {
                    bossBanList.push("Childe");
                    bossesToBan.push("Childe");
                }
            }

            updateBossPool(bossesToBan);
            displayBossBanList();
            display.textContent = `Ban: Bosses. ${bossesToBan.length} bosses were added to the ban list. Total: ${bossBanList.length}`;
        }
    } else { // Character Bans
        let numToBan = 8;
        // Apply "Double Down" boon effect
        if (activeBoons.includes("Double Down")) {
            numToBan += 8;
        }

        // Ensure we don't try to ban more than available characters
        const charsToBan = [];
        const poolForBan = characterPool.filter(char => !exclusionList.includes(char));
        if (poolForBan.length === 0) {
            display.textContent = "Ban: Characters. (No characters left to ban!)";
        } else {
            const actualNumToBan = Math.min(numToBan, poolForBan.length);

            while (charsToBan.length < actualNumToBan) {
                const randomIndex = Math.floor(Math.random() * poolForBan.length);
                const char = poolForBan.splice(randomIndex, 1)[0];
                if (!exclusionList.includes(char)) {
                    charsToBan.push(char);
                    exclusionList.push(char);
                }
            }
            
            // Apply "No ‚ÄúChilde‚Äù Policy" boon effect for Tartaglia ban
            if (activeBoons.includes("No ‚ÄúChilde‚Äù Policy") && !exclusionList.includes("Childe")) {
                exclusionList.push("Childe");
                charsToBan.push("Childe");
            }
            
            updateCharacterPool(charsToBan);
            displayExclusionList();
            display.textContent = `Ban: Characters. ${charsToBan.length} characters were added to the exclusion list. Total: ${exclusionList.length}`;
        }
    }

    // Keep the Roll Ban Category button disabled after one successful roll
    document.getElementById('btn-roll-ban-category').disabled = true;
}

// --- CHARACTER POOL MANAGEMENT (UNCHANGED) ---

function updateCharacterPoolStatus() {
document.getElementById('current-pool-status').textContent = `Total Characters Available: ${characterPool.length}`;
}

function updateCharacterPool(namesToRemove) {
// Remove the used characters from the characterPool
characterPool = characterPool.filter(char => !namesToRemove.includes(char));
updateCharacterPoolStatus();
}

function displayExclusionList() {
const listElement = document.getElementById('exclusion-list');
listElement.innerHTML = ''; // Clear existing list

if (exclusionList.length === 0) {
listElement.innerHTML = '<p style="color: #0a3a7c; font-weight: normal;">Enter the number of characters to exclude and click the button.</p>';
// Hide unban button if the list is empty
document.getElementById('btn-unban-selected').style.display = 'none';
return;
}

exclusionList.forEach(name => {
const charSpan = document.createElement('span');
charSpan.className = 'char-name';
charSpan.textContent = name;
// The click handler toggles the 'selected' class
charSpan.onclick = () => charSpan.classList.toggle('selected');
listElement.appendChild(charSpan);
});

// Ensure the unban button is visible if there are characters in the list AND the list has been generated
if (isExclusionGenerated) {
    document.getElementById('btn-unban-selected').style.display = 'inline-block';
}
}

function resetCharacterPool() {
// FIX: Use a Set to automatically remove any duplicate entries from the 
// 'characters' array, ensuring a clean pool and fixing the reported bug.
characterPool = Array.from(new Set(characters)); 
exclusionList.length = 0;
updateCharacterPoolStatus();
displayExclusionList();
}


// --- BOSS ROLL CORE LOGIC (MODIFIED) ---

/**
 * Rolls a single boss, removes it from the pool (unless Boomerang Effect is active), and returns the boss object.
 * DOES NOT update the main UI display or log the score.
 */
function rollBossSingle() {
    if (bossPool.length === 0) {
        return null;
    }
    const randomIndex = Math.floor(Math.random() * bossPool.length);
    const rolledBoss = bossPool[randomIndex];
    
    // Remove from pool UNLESS Boomerang Effect is active
    if (!activeBoons.includes("Boomerang Effect")) {
        bossPool.splice(randomIndex, 1); 
        updateBossPoolStatus(); // Update status only if removed
    }
    
    return rolledBoss;
}

/**
 * Updates the UI display to show the boss that is waiting to be logged.
 */
function updateCurrentBossDisplay(bossObject) {
    const bossNameElement = document.getElementById('boss-name');
    const parametersArea = document.getElementById('parameters-area');

    if (!bossObject) {
        bossNameElement.textContent = (rolledBosses.length >= parseInt(document.getElementById('boss-rotation-input').value)) 
                                    ? "Rotation Complete!" 
                                    : "BOSS POOL EMPTY. Cannot roll new boss.";
        parametersArea.innerHTML = "";
        document.getElementById('btn-quick-reroll').style.display = 'none';
        document.getElementById('btn-roll-next').disabled = true; // Disable if no boss to log/roll
        return;
    }

    // 1. Update UI
    bossNameElement.textContent = bossObject.name;
    const bossObjectFull = getBossObjectByName(bossObject.name); // Ensure we get description from original list
    if (bossObjectFull && bossObjectFull.description) {
        parametersArea.innerHTML = `<p id="boss-parameters-title">Additional Challenge:</p><p id="boss-parameters-description">${bossObjectFull.description}</p>`;
    } else {
        parametersArea.innerHTML = "";
    }

    // 2. Add flash animation
    bossNameElement.classList.remove('flash');
    void bossNameElement.offsetWidth; // Trigger reflow
    bossNameElement.classList.add('flash');
    
    // 3. Update button visibility
    document.getElementById('btn-quick-reroll').style.display = 'inline-block';
    document.getElementById('btn-roll-next').disabled = false;
}


function handleBossRoll() {
    // PREREQUISITE CHECK
    if (!isExclusionGenerated) {
        alert("Please complete the setup in the left column first: Generate Exclusions.");
        return;
    }

    const rotationSize = parseInt(document.getElementById('boss-rotation-input').value);
    
    // A. HANDLE START OF ROTATION (First roll - NO log action required yet)
    if (!currentBossToLog) {
        // Enforce a single roll on first click because no score has been selected for the first boss.
        const firstBoss = rollBossSingle();
        
        if (firstBoss) {
            currentBossToLog = firstBoss.name;
            updateCurrentBossDisplay(firstBoss);
            // Update button text to prompt for log action
            document.getElementById('btn-roll-next').textContent = 'Log Run & Roll Next Boss';
        } else {
            alert(`Boss Pool Empty. Cannot start rotation.`);
            document.getElementById('boss-name').textContent = "BOSS POOL EMPTY. Cannot roll new boss.";
        }
        updateStatus(rotationSize);
        return; 
    }

    // B. LOGGING AND BATCH ROLLING (Subsequent rolls)
    
    const selectedScore = parseInt(document.querySelector('input[name="penalty_score"]:checked').value);
    const rollCountInput = document.getElementById('boss-roll-count');
    let rollsRequested = parseInt(rollCountInput.value);
    rollsRequested = (isNaN(rollsRequested) || rollsRequested < 1) ? 1 : rollsRequested;
    
    currentScore += selectedScore;
    const bossEntry = `[Score ${selectedScore}/8] ${currentBossToLog}`;
    rolledBosses.push(bossEntry);
    currentBossToLog = null;
    
    // 2. Check if rotation is now complete after logging Boss A
    if (rolledBosses.length >= rotationSize) {
        updateCurrentBossDisplay(null); // Clears display and shows "Rotation Complete!"
        showFinalScoreModal(rotationSize);
        document.getElementById('btn-quick-reroll').style.display = 'none';
        document.getElementById('btn-roll-next').textContent = 'Rotation Complete!';
        document.getElementById('btn-roll-next').disabled = true;
        return;
    }
    
    let lastRolledBossObject = null;
    // The number of bosses to roll in the batch is determined by 'rollsRequested'
    const remainingSpots = rotationSize - rolledBosses.length;
    const actualRolls = Math.min(rollsRequested, remainingSpots);

    // Loop: Roll a boss (Boss B...N), log it immediately with the same score (except for the last one)
    for (let i = 0; i < actualRolls; i++) {
        const rolledBoss = rollBossSingle(); 
        
        if (!rolledBoss) {
            alert(`Boss Pool Empty. Only ${rolledBosses.length} bosses rolled out of ${rotationSize}.`);
            break;
        }

        // Check if this is NOT the last boss in the batch
        if (i < actualRolls - 1) { 
            // Log it immediately (Boss B, C, etc.)
            currentScore += selectedScore;
            const logEntry = `[Score ${selectedScore}/8] ${rolledBoss.name}`;
            rolledBosses.push(logEntry);
            
            // If rotation is complete mid-batch
            if (rolledBosses.length >= rotationSize) {
                 actualRolls = i + 1; // Stop the loop
                 break;
            }
        } else {
            // This is the last boss, it will be displayed and logged on the *next* button press
            lastRolledBossObject = rolledBoss;
        }
    }

    // D. FINAL UI UPDATES
    if (lastRolledBossObject) {
        currentBossToLog = lastRolledBossObject.name;
        updateCurrentBossDisplay(lastRolledBossObject);
    } else {
         // If rotation was completed mid-batch or pool was empty
         updateCurrentBossDisplay(null); 
    }
    
    updateRolledList();
    updateScoreDisplay();
    updateStatus(rotationSize);
    
    // Ensure button text is correct
    if (rolledBosses.length >= rotationSize) {
        document.getElementById('btn-roll-next').textContent = 'Rotation Complete!';
        document.getElementById('btn-quick-reroll').style.display = 'none';
        document.getElementById('btn-roll-next').disabled = true;
    } else {
        document.getElementById('btn-roll-next').textContent = 'Log Run & Roll Next Boss';
    }
}


function rerollBoss() {
    // PREREQUISITE CHECK
    if (!isExclusionGenerated || !currentBossToLog) return;
    
    const oldBossName = currentBossToLog;

    // 1. Roll a new boss
    const newBoss = rollBossSingle();
    
    if (!newBoss) {
        alert("Boss Pool is empty, cannot reroll.");
        return;
    }
    
    // 2. Update UI with the new boss (This also handles the flash effect)
    updateCurrentBossDisplay(newBoss);

    // 3. Put the old boss back into the pool, only if Boomerang Effect is NOT active (since it wouldn't have been removed in the first place if it was active)
    if (!activeBoons.includes("Boomerang Effect")) {
        const oldBossObject = getBossObjectByName(oldBossName);
        if (oldBossObject && !bossPool.some(boss => boss.name === oldBossName)) {
            bossPool.push(oldBossObject);
            updateBossPoolStatus();
        }
    }
    
    // 4. Update the state
    currentBossToLog = newBoss.name; 
    lastRerolledBoss = oldBossName; // Keep track of the boss that was just rerolled
}

function resetRotationAndReroll() {
    // PREREQUISITE CHECK - Only need exclusion to be generated
    if (!isExclusionGenerated) return;

    // 1. Reset Boss/Score State
    resetBossRotation();
    // The current bossPool (which contains category bans) is preserved.

    updateStatus(document.getElementById('boss-rotation-input').value);
    updateScoreDisplay();
    
    // Reset button text
    document.getElementById('btn-quick-reroll').style.display = 'none';
    
    // 2. Roll the first boss of the new rotation
    const firstBoss = rollBossSingle();
    
    if (firstBoss) {
        currentBossToLog = firstBoss.name;
        updateCurrentBossDisplay(firstBoss);
        // Change button text to indicate the next action is a log
        document.getElementById('btn-roll-next').textContent = 'Roll next boss';
    } else {
        document.getElementById('boss-name').textContent = "BOSS POOL EMPTY. Cannot roll new boss.";
        document.getElementById('parameters-area').innerHTML = "";
        document.getElementById('btn-roll-next').textContent = 'Rotation Complete!';
        document.getElementById('btn-roll-next').disabled = true;
    }
}

function resetBossRotation() {
    rolledBosses.length = 0;
    currentScore = 0;
    currentBossToLog = null;
    lastRerolledBoss = null;
    updateRolledList();
    updateScoreDisplay();
    updateStatus(document.getElementById('boss-rotation-input').value);
}


// --- CHARACTER ROLL LOGIC (MODIFIED) ---

function randomizeCharacters(count) {
    // PREREQUISITE CHECK - Only need exclusion to be generated
    if (!isExclusionGenerated) {
        alert("Please complete the setup in the above column: Generate Exclusions.");
        return;
    }

    // 1. Clear previous squad and display
    currentRolledSquad.length = 0;
    const display = document.getElementById('character-display');
    display.innerHTML = '';
    const selectionMessage = document.getElementById('selection-message');
    selectionMessage.textContent = "You must select at least 4 characters used before confirming.";
    
    // **NEW LOGIC START: Filter pool if 'Four-Star Impact' is active**
    let poolToRollFrom = [...characterPool]; // Start with the full current pool
    
    // Check if the "Four-Star Impact" boon is active
    if (activeBoons.includes("Four-Star Impact")) {
        // Filter out all known 5-star characters to enforce "4 star only" rolls
        poolToRollFrom = poolToRollFrom.filter(char => !fiveStarCharacters.includes(char));
        selectionMessage.textContent = `"Four-Star Impact" active! Rolling only from the ${poolToRollFrom.length} available 4-star characters.`;
        selectionMessage.style.display = 'block';
    } else {
        selectionMessage.style.display = 'none';
    }
    // **NEW LOGIC END**

    // MODIFIED LOGIC: Roll based on available pool size if it's less than the requested count (8)
    const actualRollCount = Math.min(count, poolToRollFrom.length);

    // Check if the pool is empty (no characters available after filtering/elimination)
    if (actualRollCount === 0) {
        display.innerHTML = '<p style="color: red; font-weight: bold;">Error: The character pool is empty. Reset lists to continue.</p>';
        document.getElementById('btn-roll-chars').style.display = 'inline-block';
        document.getElementById('btn-reroll-chars').style.display = 'none';
        document.getElementById('btn-confirm-usage').disabled = true; 
        return;
    }

    // 2. Randomize the squad (without replacement)
    // Use the potentially filtered poolToRollFrom for the actual roll
    let tempPool = [...poolToRollFrom]; 
    for (let i = 0; i < actualRollCount; i++) { // Use actualRollCount to ensure we only draw what's available
        const randomIndex = Math.floor(Math.random() * tempPool.length);
        const charName = tempPool.splice(randomIndex, 1)[0];
        currentRolledSquad.push(charName);
    }

    // 3. Render the new squad with actual images
    currentRolledSquad.forEach(name => {
        const imagePath = CHAR_IMAGE_MAP[name] || CHAR_IMAGE_MAP["DEFAULT_PATH"];

        // Create the card wrapper
        const charCard = document.createElement('div');
        charCard.className = 'character-card';

        // Create the name span (char-name)
        const charSpan = document.createElement('span');
        charSpan.className = 'char-name';
        charSpan.textContent = name;
        
        // Create the image placeholder container
        const imgContainer = document.createElement('div');
        imgContainer.className = 'char-image-placeholder';
        
        // Create the actual image element
        const imgElement = document.createElement('img');
        imgElement.src = imagePath;
        imgElement.alt = name;
        
        // Append the image to the container
        imgContainer.appendChild(imgElement);

        // Add click handler to the card wrapper
        charCard.onclick = () => charCard.classList.toggle('selected');
        
        // Assemble the card
        charCard.appendChild(charSpan);
        charCard.appendChild(imgContainer); 
        
        // Append to display
        display.appendChild(charCard);
    });

    // 4. Update button visibility (Hide Roll, Show Reroll, Enable Confirm)
    document.getElementById('btn-roll-chars').style.display = 'none';
    document.getElementById('btn-reroll-chars').style.display = 'inline-block';
    document.getElementById('btn-confirm-usage').disabled = false;
}

function rerollCharacters() {
    // PREREQUISITE CHECK - Only need exclusion to be generated
    if (!isExclusionGenerated) return;

    const display = document.getElementById('character-display');
    const selectionMessage = document.getElementById('selection-message');

    if (currentRolledSquad.length === 0) {
        selectionMessage.textContent = 'No squad has been rolled yet to reroll.';
        selectionMessage.style.display = 'block';
        return;
    }

    // Clear the old squad
    currentRolledSquad.length = 0; 
    
    // 2. Inform the user and roll a new squad
    display.innerHTML = '<p>Rerolling...</p>';
    selectionMessage.style.display = 'none';
    document.getElementById('btn-confirm-usage').disabled = true;

    // This call uses the same logic as the initial roll, ensuring the "Four-Star Impact" boon filter is applied again.
    randomizeCharacters(8); 
}

function confirmUsedCharacters() {
    // UPDATED: Look for the name inside the selected card (.character-card.selected)
    const selectedChars = Array.from(document.querySelectorAll('#character-display .character-card.selected .char-name')).map(el => el.textContent);
    const selectionMessage = document.getElementById('selection-message');

    if (selectedChars.length < 1) {
        selectionMessage.textContent = `You must select at least 1 character used before confirming. (${selectedChars.length} selected)`;
        selectionMessage.style.display = 'block';
        return;
    }

    let charsToEliminate = selectedChars;

    // --- NEW LOGIC FOR "Four-Star Impact" BOON (Elimination Logic) ---
    if (activeBoons.includes("Four-Star Impact")) {
        // Filter the selected characters: only keep 5-star characters (i.e., those NOT in the FOUR_STAR_CHARS list).
        const fourStarsPreserved = selectedChars.filter(name => FOUR_STAR_CHARS.includes(name));
        
        // Note: Characters in charsToEliminate are 5-stars if the boon is active (based on the provided list)
        charsToEliminate = selectedChars.filter(name => !FOUR_STAR_CHARS.includes(name));
        
        if (charsToEliminate.length === 0) {
            selectionMessage.textContent = `"Four-Star Impact" active. All ${fourStarsPreserved.length} selected characters are 4-stars and were preserved. Pool size remains unchanged.`;
        } else {
            selectionMessage.textContent = `"Four-Star Impact" active. ${charsToEliminate.length} 5-stars eliminated. ${fourStarsPreserved.length} 4-stars preserved.`;
        }
        selectionMessage.style.display = 'block';
    }
    // --- END NEW LOGIC ---

    // Remove selected characters from the main pool
    if (charsToEliminate.length > 0) {
        updateCharacterPool(charsToEliminate);
    }
    
    // Clear the character display and squad
    currentRolledSquad.length = 0;
    document.getElementById('character-display').innerHTML = '<p>Character usage confirmed. Click "Roll Characters" to generate the next squad.</p>';
    // If the boon wasn't active, ensure the generic selection message is hidden
    if (!activeBoons.includes("Four-Star Impact")) {
        selectionMessage.style.display = 'none';
    }


    // Reset button visibility (Show Roll, Hide Reroll, Disable Confirm)
    document.getElementById('btn-roll-chars').style.display = 'inline-block';
    document.getElementById('btn-reroll-chars').style.display = 'none';
    document.getElementById('btn-confirm-usage').disabled = true;
}

// --- NEW FUNCTION: Handles unbanning selected characters (UNCHANGED) ---
function handleUnbanSelected() {
    const listElement = document.getElementById('exclusion-list');
    // Get all selected character name elements
    const selectedSpans = Array.from(listElement.querySelectorAll('.char-name.selected'));
    
    if (selectedSpans.length === 0) {
        alert("Please select at least one character in the exclusion list to unban.");
        return;
    }

    const namesToUnban = selectedSpans.map(span => span.textContent);
    
    // 1. Remove from exclusionList
    const newExclusionList = exclusionList.filter(name => !namesToUnban.includes(name));

    // Clear the global array and repopulate it with the remaining names
    exclusionList.length = 0; 
    exclusionList.push(...newExclusionList); 

    // 2. Add to characterPool
    namesToUnban.forEach(name => {
        // Add back to the pool if it's not already there (safety)
        if (!characterPool.includes(name)) {
            characterPool.push(name);
        }
    });

    // 3. Update UI
    displayExclusionList();
    updateCharacterPoolStatus();
    
    alert(`${namesToUnban.length} character(s) unbanned and returned to the pool!`);
}


// --- NEW FUNCTION: Read and validate exclusion count (UNCHANGED)
function handleGenerateExclusions() {
    const countInput = document.getElementById('exclusion-count-input');
    const count = parseInt(countInput.value);
    
    // If exclusions have already been generated, skip regeneration logic
    if (isExclusionGenerated) {
        alert("Exclusions have already been generated for this session. Use 'Unban Selected' or 'Reset Character Lists' to change.");
        return;
    } 

    if (isNaN(count) || count < 1 || count > characterPool.length) {
        alert(`Please enter a valid number between 1 and ${characterPool.length} for exclusion.`);
        return;
    }

    generateExclusionList(count); 
}

// --- MODIFIED CORE LOGIC: Accepts count as an argument (UNCHANGED)
function generateExclusionList(count) {
    if (characterPool.length < count) {
        document.getElementById('exclusion-list').innerHTML = '<p style="color: red; font-weight: bold;">Not enough characters left to exclude. Reset the character lists & pool to continue.</p>';
        return;
    }

    let tempPool = [...characterPool];
    const newlyExcluded = [];

    for (let i = 0; i < count; i++) {
        const randomIndex = Math.floor(Math.random() * tempPool.length);
        const char = tempPool.splice(randomIndex, 1)[0];
        newlyExcluded.push(char);
        exclusionList.push(char);
    }
    
    // Apply "No ‚ÄúChilde‚Äù Policy" boon effect for initial ban
    if (activeBoons.includes("No ‚ÄúChilde‚Äù Policy") && !exclusionList.includes("Childe")) {
        // Check if Childe is in the pool before trying to ban
        if (characterPool.includes("Childe") || newlyExcluded.includes("Childe")) {
             // If already in exclusion list, this is fine, otherwise add and remove from pool
             if(!exclusionList.includes("Childe")) exclusionList.push("Childe");
             if(newlyExcluded.includes("Childe")) newlyExcluded.splice(newlyExcluded.indexOf("Childe"), 1); // remove if randomly selected
             newlyExcluded.push("Childe");
        } else {
             // If Childe is already used/removed, nothing happens
        }
    }


    // Remove the newly excluded characters from the pool
    updateCharacterPool(newlyExcluded);

    // Update UI
    displayExclusionList();

    // STATE PROGRESSION: Exclusions are done, unlock all main features
    isExclusionGenerated = true;
    document.getElementById('btn-generate-exclusions').disabled = true;
    document.getElementById('btn-unban-selected').style.display = 'inline-block'; // Show Unban button
    
    // UNLOCK MAIN CHALLENGE BUTTONS DIRECTLY
    document.getElementById('btn-roll-next').disabled = false;
    document.getElementById('btn-roll-chars').disabled = false;
    
    // Enable the optional Ban Category roll. If "Fast Food Combo Meal" is active, it's auto-run below, but keep button disabled after 1 use.
    document.getElementById('btn-roll-ban-category').disabled = false; 

    // Update main challenge messages
    document.getElementById('boss-name').textContent = "Ready! Click 'Roll Next Boss / Log Run' to begin the rotation!";
    document.getElementById('parameters-area').innerHTML = "";
    document.getElementById('character-display').innerHTML = '<p>Click "Roll Characters" to generate a squad of 8. Select a minimum of 4 characters used from the rolled team to remove them from the pool.</p>';
    
    // Check for "Fast Food Combo Meal" boon and run ban phase immediately
    if (activeBoons.includes("Fast Food Combo Meal")) {
        runCategoryBan(); // Automatically runs the ban and disables the button
    } else {
        // Update category ban display message
        document.getElementById('category-ban-display').textContent = 'Optional: Click "Roll Ban Category" for an extra challenge.';
    }
    
    // Maximize roll count input based on rotation size
    const rotationSize = parseInt(document.getElementById('boss-rotation-input').value);
    document.getElementById('boss-roll-count').max = rotationSize;
}

function resetCharacterLists() {
    resetCharacterPool();
    // Clear the character display and squad
    currentRolledSquad.length = 0;
    document.getElementById('character-display').innerHTML = '<p>Click "Roll Characters" to generate a squad of 8. Select a minimum of 4 characters used from the rolled team to remove them from the pool.</p>';
    document.getElementById('selection-message').style.display = 'none';

    // Reset button visibility
    document.getElementById('btn-roll-chars').style.display = 'inline-block';
    document.getElementById('btn-reroll-chars').style.display = 'none';
    document.getElementById('btn-confirm-usage').disabled = true;
    
    // If game has started (exclusions were done), reset the exclusion generator state
    if (isExclusionGenerated) {
        setInitialGameLocks(); // This will put it back to the pre-exclusion state
    }
}


// --- MODAL LOGIC (MODIFIED) ---

function showFinalScoreModal(rotationSize) {
// UPDATED: Changed 4 to 8
const maxPossibleScore = rotationSize * 8;
const percentage = ((currentScore / maxPossibleScore) * 100).toFixed(1);

document.getElementById('modal-score-current').textContent = currentScore;
document.getElementById('modal-score-max').textContent = maxPossibleScore;
document.getElementById('modal-score-percentage').textContent = `${percentage}% of Max Score`;

// Open the modal
document.getElementById('final-score-modal').classList.add('open');
}

function closeFinalScoreModal() {
document.getElementById('final-score-modal').classList.remove('open');
// After closing, automatically start a new rotation by using the non-ban-clearing reset
resetRotationAndReroll();
}


// --- GLOBAL RESET (UNCHANGED) ---

/**
 * Disables all main action buttons until prerequisites are met (now only exclusion).
 */
function updateStatus(rotationSize) {
    document.getElementById('rotation-status').textContent = `${rolledBosses.length}/${rotationSize} bosses done`;
}

function setInitialGameLocks() {
    isExclusionGenerated = false;
    
    // Disable main action buttons
    document.getElementById('btn-roll-next').disabled = true;
    document.getElementById('btn-quick-reroll').style.display = 'none'; 
    document.getElementById('btn-roll-chars').disabled = true;
    document.getElementById('btn-confirm-usage').disabled = true;
    document.getElementById('btn-roll-next').textContent = 'Roll Next Boss / Log Run'; // Reset button text

    // Control setup flow
    document.getElementById('btn-roll-ban-category').disabled = true; // Still disabled until exclusions are done
    document.getElementById('btn-generate-exclusions').disabled = false;
    document.getElementById('btn-unban-selected').style.display = 'none'; // Hide Unban button initially

    // Set locked messages
    document.getElementById('boss-name').textContent = "üîí Locked: Complete setup in the bans/score area first.";
    document.getElementById('parameters-area').innerHTML = "";
    document.getElementById('character-display').innerHTML = '<p style="color: #e64a19; font-weight: bold;">üîí Locked: Complete exclusion setup first.</p>';
    // UPDATED MESSAGE: Reflecting the custom input
    document.getElementById('category-ban-display').textContent = 'Setup Step: Enter exclusion count and click "Generate Exclusions" to unlock rolls.';
    
    // Reset inputs
    document.querySelector('input[name="penalty_score"][value="0"]').checked = true;
    
    // Update boon button state
    updateBoonActivationButton();
}


function resetEntireGame() {
    const isConfirmed = window.confirm("Are you sure you want to reset the ENTIRE game? This will clear all score, bans, and character rolls.");
        
    if (!isConfirmed) {
        return;
    }

    // 1. Reset Boss/Score State (Full wipe including bans)
    resetBossRotation();
    resetBossPool();

    // 2. Reset Character State (Full wipe including exclusions)
    resetCharacterLists();

    // 3. Reset Boons
    activeBoons = [];
    boonActivationUses = {};
    document.querySelectorAll('input[name="boon"]').forEach(checkbox => checkbox.checked = false);
    handleBoonChange(); // Update the display

    // 4. Reset UI Elements and Game Locks
    setInitialGameLocks();
    initializeApp(); // Re-run initialization to reset UI states like 'Total Characters Available'

    console.log("The game has been reset!");
}


// --- INITIALIZATION ---

function initializeApp() {
    // 1. Setup initial boss pool
    bossesOriginal = [...initialBosses];
    resetBossPool();
    
    // 2. Setup initial character pool
    resetCharacterPool(); 
    
    // 3. Set initial UI state
    const input = document.getElementById('boss-rotation-input');
    input.value = Math.min(bossesOriginal.length, 12); 
    updateStatus(input.value);
    updateRolledList(); 
    updateScoreDisplay(); 
    
    // 4. Render Boons
    renderBoons(); // New call to render the boon list
    
    // 5. Apply initial locks
    setInitialGameLocks();
    
    // 6. Set max value on exclusion input dynamically
    const exclusionInput = document.getElementById('exclusion-count-input');
    exclusionInput.max = characterPool.length;
    // ensure initial value of 6 is valid, if not, reset it
    if (parseInt(exclusionInput.value) > characterPool.length) {
        exclusionInput.value = Math.min(6, characterPool.length);
    }
    
    // Set max value on boss roll count input dynamically
    document.getElementById('boss-roll-count').max = parseInt(input.value);
}

document.addEventListener('DOMContentLoaded', initializeApp);

</script>

</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Hyoukomi's Boss Roulette</title>
<link href="https://fonts.googleapis.com/css2?family=Cherry+Bomb+One&family=Quicksand:wght@300..700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="style.css">
</head>
<body>

<div id="main-header-title-wrapper">
    <div id="title-icon-placeholder"></div>
    <h1 id="page-title">Hyoukomi's Boss Roulette üå∏</h1>
</div>

<button id="btn-reset-all" onclick="resetEntireGame()">Restart game</button>

<div class="full-width-boons-wrapper">
    <div class="boons-selector card">

        <div class="boon-toggle-header" onclick="toggleBoonsDropdown()">
            <h2>Selectable Boons<span id="toggle-icon">></span></h2>
        </div>

        <div id="boon-list-master-wrapper" style="max-height: 0; overflow: hidden; transition: max-height 0.4s ease-out;">
            <div class="boon-list-container" id="boon-list-master">
                </div>
        </div>

        <div id="active-boons-list" style="margin-top: 20px; padding: 10px; border-top: 1px solid #0a3a7c; font-style: italic; color: #0a3a7c; font-size: 0.9em;">
            <p style="margin: 0;"><strong>Active Boons:</strong> None selected.</p>
        </div>
        
        <div class="button-group" style="justify-content: center; margin-top: 15px; padding: 0 10px 10px 10px;">
            <button class="btn-primary" id="btn-activate-boon" onclick="handleBoonActivation()" disabled>Activate Selected Boon</button>
        </div>
        </div>
</div>
<div class="page-layout">

<div class="left-column card">
    <p>Step 1: </p>
    <div class="exclusion-generator" style="margin-top: 0;"> <h2>Character Bans</h2>
        <div class="control-group" style="justify-content: flex-start; margin-bottom: 20px;">
            <label for="exclusion-count-input" style="font-weight: bold;">Number of character bans:</label>
            <input type="number" id="exclusion-count-input" value="6" min="1" max="99" style="width: 50px; padding: 5px; border-radius: 4px; background-color: rgba(255, 192, 203, 0.4); border: 1px solid #0a3a7c; text-align: center; color: #0a3a7c;">
        </div>
        <div id="exclusion-list">
        <p style="color: #0a3a7c; font-weight: normal;">Enter the number of characters to ban.</p>
        </div>
        <div class="button-group" style="justify-content: flex-start; margin-top: 10px; margin-bottom: 0;">
            <button class="btn-tertiary-blue" id="btn-generate-exclusions" onclick="handleGenerateExclusions()">Generate character bans</button>
            <button class="btn-secondary" id="btn-unban-selected" onclick="handleUnbanSelected()" style="display: none;">Unban Selected</button>
        </div>
    </div>
    
    <div class="category-ban-randomizer" style="margin-top: 30px;">
        <p>Step 2: </p>
        <h2>Category Ban</h2>
        <div id="category-ban-display" style="margin-bottom: 15px;">Choose a ban type and amount.</div>
        
        <div class="control-group" style="justify-content: flex-start; margin-bottom: 20px; gap: 10px; display: flex; align-items: center;">
            <select id="ban-type-select" style="padding: 5px; border-radius: 4px; border: 1px solid #0a3a7c; background: white; color: #0a3a7c;">
                <option value="Bosses">Boss Bans</option>
                <option value="Characters">Character Bans</option>
            </select>
            <input type="number" id="manual-ban-count" value="10" min="1" max="50" style="width: 50px; padding: 5px; border-radius: 4px; background-color: rgba(255, 192, 203, 0.4); border: 1px solid #0a3a7c; text-align: center; color: #0a3a7c;">
        </div>

        <div style="text-align: left; margin-bottom: 30px;">
        <button class="btn-secondary" id="btn-roll-ban-category" onclick="runCategoryBan()">Apply Bans</button>
        </div>

        <h3>Boss Ban List</h3>
        <div id="boss-ban-list">
        <p style="color: #0a3a7c; font-weight: normal;">No bosses currently banned.</p>
        </div>
        <p id="boss-pool-status" style="font-size: 0.9em; margin-top: 10px; color: #0a3a7c; font-weight: bold;">Total Bosses Available: 50</p>
    </div>
</div>

<div class="sidebar card">
<h2>Death Penalty</h2>
<div class="score-info">
<span id="score-current">Current: 0</span>
<span id="score-max"></span>
</div>
<hr style="display: none;"/>

<h2>Bosses rolled this cycle: </h2>
<ol id="rolled-list">
<li>No bosses rolled yet.</li>
</ol>
</div>


<div class="boss-randomizer card">
<h1>Boss Roulette Game Start</h1>

<div class="controls-area">
<div class="control-group">
<label for="boss-rotation-input" style="font-weight: bold;">Rotation Size: </label>
<input type="number" id="boss-rotation-input" value="12" min="1" max="50" onchange="updateScoreDisplay()">
</div>
<div class="control-group">
<label style="font-weight: bold;">Status:</label>
<span id="rotation-status">0/12 bosses done</span>
</div>
</div>

<div id="boss-display">
<h2 id="boss-name">Roll a boss to begin the rotation!</h2>
<div id="parameters-area" style="width: 100%;">
</div>
</div>

<div class="scoring-section" id="scoring-area">
<h2>How many of you threw?</h2>
<p>Select how many people died for this boss.</p>
<div class="score-controls">
<label><input type="radio" name="penalty_score" value="0" checked> 0</label>
<label><input type="radio" name="penalty_score" value="1"> 1</label>
<label><input type="radio" name="penalty_score" value="2"> 2</label>
<label><input type="radio" name="penalty_score" value="3"> 3</label>
<label><input type="radio" name="penalty_score" value="4"> 4</label>
<label><input type="radio" name="penalty_score" value="5"> 5</label>
<label><input type="radio" name="penalty_score" value="6"> 6</label>
<label><input type="radio" name="penalty_score" value="7"> 7</label>
<label><input type="radio" name="penalty_score" value="8"> 8</label>
</div>
</div>

<div class="button-group" id="roll-button-group">
    <div class="control-group" style="gap: 5px; flex-shrink: 0; align-self: center;"> 
        <label for="boss-roll-count" style="font-size: 0.9em; font-weight: bold; color: #0a3a7c;">Roll Count:</label>
        <input type="number" id="boss-roll-count" value="1" min="1" max="12" style="width: 40px; padding: 5px; border-radius: 4px; background-color: rgba(255, 192, 203, 0.4); border: 1px solid #0a3a7c; text-align: center; color: #0a3a7c;">
    </div>
    <button class="btn-primary" id="btn-roll-next" onclick="handleBossRoll()">Roll Next Boss / Log Run</button>
    <button class="btn-secondary" id="btn-quick-reroll" onclick="rerollBoss()" style="display: none;">Quick Reroll</button>
</div>
<button class="btn-reset" id="btn-reset-reroll" onclick="resetRotationAndReroll()">Reset Rotation & Reroll Boss</button>
<p style="margin-top: 25px; margin-bottom: 0; font-size: 0.9em; color: #0a3a7c; text-align: center;"> *The next roll will automatically log the status of the previously rolled boss using the selected penalty score. </p>
</div>

<div class="full-width-character-selector card">
<h1>Genshin Character Randomizer</h1>
<div class="character-randomizer">
<h2>‚ú® 8 Character Randomizer</h2>
<div id="character-display">
<p>Click "Roll Characters" to generate 8 characters. Select all 8 characters for regular runs and the 4 used for Omniscient runs.</p>
</div>
<p id="selection-message">You must select at least 4 characters used before confirming.</p>
<div id="current-pool-status" style="text-align: center; font-weight: bold; margin-bottom: 15px; color: #0a3a7c;">Total Characters Available: 99</div>
<div class="button-group" style="margin-top: 0; margin-bottom: 15px;">
<button class="btn-tertiary" id="btn-roll-chars" onclick="randomizeCharacters(8)">Roll Characters</button>
<button class="btn-secondary" id="btn-reroll-chars" onclick="rerollCharacters()" style="display: none;">Reroll Characters</button>
<button class="btn-primary" id="btn-confirm-usage" onclick="confirmUsedCharacters()">Confirm selected as used characters</button>
</div>
<div style="text-align: center;">
<button class="btn-reset" onclick="resetCharacterLists()">Reset Character Pool</button>
</div>
</div>
</div>


</div> <div id="final-score-modal" class="modal-overlay">
<div class="modal-content">
<h2 style="margin-bottom: 10px;">Rotation Complete!</h2>
<p>You have finished the challenge rotation.</p>
<div id="modal-score-details">
<p>Death count: <span id="modal-score-current">0</span></p>
<p style="margin-top: 5px;">Ignore this lol <span id="modal-score-max">48</span></p>
<h3 id="modal-score-percentage"></h3>
</div>
<button id="modal-confirm-button" class="btn-primary" onclick="closeFinalScoreModal()">Confirm & Start New Game</button>
</div>
</div>

<script>
// Global state tracking
let rolledBosses = [];
let lastRerolledBoss = null;
let currentBossToLog = null;
let currentScore = 0; 
// Character squad state
let currentRolledSquad = [];
let activeBoons = []; // STATE TRACKER for boons
// NEW STATE: Track uses for activatable/consumable boons
let boonActivationUses = {}; 

// NEW STATE TRACKERS for setup control
let isExclusionGenerated = false; // Only one state tracker needed now

// Boss Pool State
let bossesOriginal = [];
let bossPool = [];
const bossBanList = [];

// Character Pool State
let characterPool = [];
const exclusionList = [];

// --- DATA ARRAYS (Definitions) ---
const initialBosses = [
{ name: "Geo Hypostasis", description: "Requires at least one Sword, Claymore or Polearm character" },
{ name: "Pyro Hypostasis", description: "Requires at least one Hydro or Cryo character" },
{ name: "Dendro Hypostasis", description: "Requires at least one Dendro or Hydro character" },
{ name: "SSA: Configuration Device", description: "Requires characters capable of height ascension" },
{ name: "Wayward Hermetic Spiritspeaker", description: "Requires at least one Pyro or Electro character" },
{ name: "SSA: Overseer Device", description: "Requires at least one character capable of high-frequency Cryo application" },
{ name: "Joururi Workshop (Scaramouche Boss)", description: "Requires at least one character capable of interacting with and destroying the Nirvana Engine" },
{ name: "Unresolved Chess Game", description: "Requires at least one Hydro and Cryo character" },
{ name: "The Knave - Arlecchino", description: "Requires at least one character capable of healing self and others" },
{ name: "Anemo Hypostasis", description: null },
{ name: "Cryo Hypostasis", description: null },
{ name: "Cryo Regisvine", description: null },
{ name: "Electro Hypostasis", description: null },
{ name: "Oceanid", description: null },
{ name: "Primo Geovishap", description: null }, 
{ name: "Pyro Regisvine", description: null },
{ name: "Ruin Serpent", description: null },
{ name: "Solitary Suanni", description: null },
{ name: "Bathysmal Vishap Herd", description: null },
{ name: "Golden Wolflord", description: null },
{ name: "Hydro Hypostasis", description: null },
{ name: "Maguu Kenki", description: null },
{ name: "Perpetual Mechanical Array", description: null },
{ name: "Thunder Manifestation", description: null },
{ name: "Shroom Chicken", description: null },
{ name: "Electro Regisvine", description: null },
{ name: "Aeonblight Drake", description: null },
{ name: "Dorito", description: null },
{ name: "Setekh Wenut", description: null },
{ name: "Iniquitous Baptist", description: null },
{ name: "Icewind Suite", description: null },
{ name: "Emperor of Fire and Iron", description: null },
{ name: "Experimental Field Generator", description: null },
{ name: "Millennial Pearl Seahorse", description: null },
{ name: "Hydro Tulpa", description: null },
{ name: "Legatus Golem", description: null },
{ name: "Goldflame Qucusaur Tyrant", description: null },
{ name: "CaseOH", description: null },
{ name: "Radiant Moonfly", description: null },
{ name: "Knuckle Duckle", 
description: null },
{ name: "Lupus Boreas", description: null },
{ name: "Childe", description: null },
{ name: "Azhdaha", description: null },
{ name: "La Signora", description: null },
{ name: "Raiden Shogun", description: null },
{ name: "Guardian of Apep's Oasis", description: null },
{ name: "All-Devouring Narwhal", description: null },
{ name: "Lord of Eroded Primal Fire", description: null },
{ name: "Lava Dragon Statue", description: null },
{ name: "Frostnight Herra", description: null },
{ name: "Super-Heavy Landrover: Mechanized Fortress", description: null },
{ name: "Lord of the Hidden Depths: Whisperer of Nightmares", description: null },
{ name: "The Doctor - Dottore", description: null }
];
const characters = [
"Jahoda", "Durin", "Traveler", "Aloy", "Bennett", "Chevreuse", "Dehya", "Diluc", "Hu Tao", "Gaming", "Klee", "Lyney", "Thoma", "Mavuika", "Xiangling", "Xinyan", "Yanfei", "Yoimiya", "Amber", "Arlecchino", "Albedo", "Arrataki Itto", "Chiori", "Kachina", "Ningguang", "Noelle", "Xilonen", "Yunjin", "Zhongli", "Gorou", "Navia", "Ayato", "Childe", "Aino", "Candace", "Furina", "Kokomi", "Mualani", "Mona", "Nilou", "Neuvilette", "Sigewinne", "Xingqiu", "Yelan", "Dahlia", "Barbara", "Baizhu", "Collei", "Kinich", "Kaveh", "Kirara", "Lauma", "Tighnari", "Emilie", "Nefer", "Yao Yao", "Alhaitham", "Nahida", "Cyno", "Dori", "Fischl", "Beidou", "Iansan", "Ororon", "Keqing", "Ineffa", "Lisa", "Kuki Shinobu", "Kujou Sara", "Raiden Shogun", "Razor", "Rosaria", "Flins", "Sethos", "Varesa", "Yae Miko", "Wanderer", "Clorinde", "Charlotte", "Ayaka", "Chongyun", "Citlali", "Diona", "Escoffier", "Kaeya", "Layla", "Eula", "Mika", "Wriothesley", "Freminet", "Shenhe", "Skirk", 
"Qiqi", "Ganyu", "Chasca", "Faruzan", "Heizou", "Lan yan", "Ifa", "Jean", "Kazuha", "Lynette", "Sayu", "Mizuki", "Sucrose", "Venti", "Xianyun", "Xiao", "Columbina", "Illuga", "Zibai"
];

const FOUR_STAR_CHARS = [
    "Aino", "Amber", "Barbara", "Beidou", "Bennett", "Candace", "Charlotte", "Chevreuse", 
    "Chongyun", "Collei", "Dahlia", "Diona", "Dori", "Faruzan", "Fischl", "Freminet", 
    "Gaming", "Gorou", "Iansan", "Ifa", "Kachina", "Kaeya", "Kazuha", "Kaveh", "Kirara", "Kuki Shinobu", "Kujou Sara", 
    "Lan yan", "Layla", "Lisa", "Lynette", "Mika", "Ningguang", "Noelle", 
    "Ororon", "Razor", "Rosaria", "Sayu", "Sethos", "Heizou", "Sucrose", "Thoma", 
    "Xiangling", "Xingqiu", "Xinyan", "Yanfei", "Yao Yao", 
    "Yunjin", "Thoma", "Jahoda", "Illuga"
];

const fiveStarCharacters = [
    "Durin", "Dehya", "Diluc", "Hu Tao", "Klee", "Lyney", "Yoimiya", "Arlecchino", "Albedo", 
    "Arrataki Itto", "Chiori", "Zhongli", "Navia", "Ayato", "Childe", "Furina", "Kokomi", 
    "Mualani", "Mona", "Nilou", "Neuvilette", "Sigewinne", "Yelan", "Baizhu", "Tighnari", 
    "Alhaitham", "Nahida", "Cyno", "Keqing", "Raiden Shogun", "Yae Miko", "Wanderer", 
    "Clorinde", "Ayaka", "Eula", "Wriothesley", "Shenhe", "Qiqi", "Ganyu", "Jean", 
    "Kazuha", "Venti", "Xianyun", "Xiao", "Xilonen", "Kinich", "Lauma", "Emilie", "Nefer", "Ineffa", "Flins", "Varesa", "Citlali", "Escoffier", "Skirk", "Chasca", "Mizuki", "Mavuika", "Aloy", "Traveler","Columbina", "Zibai"
];

const BOONS_DATA = [
    { id: "boon-delete", name: "Delete Button", type: "Standard", description: 'Use this at any point in the session to "insta-kill" an upcoming boss. Characters rolled for the "insta-killed" boss will still be cycled out, and the boss will be counted as a clear.' },
    { id: "boon-starless", name: "Starless, Peerless Night", type: "Standard", description: 'Using 5-star characters with active constellations will contribute to the Death Count, dependent on the 5-star character constellation level. When reaching the final boss, all characters will be brought back from elimination, with all and any character available to use. 2x Roulette EXP upon clearing.' },
    { id: "boon-boomerang", name: "Boomerang Effect", type: "Standard", description: 'Bosses will no longer cycle out of the Boss Wheel for the session.' },
    { id: "boon-reckless", name: "Don‚Äôt Be Reckless!", type: "Standard", description: 'When two deaths occur in a boss fight, it is considered a wipe; however, all wipes in this session will not contribute to run failure except for wipes on the final boss.' },
    { id: "boon-doubledown", name: "Double Down", type: "Standard", description: 'For Character Ban Phases, this will ban an additional 8 characters and decrease the session\'s bosses to 11.' },
    { id: "boon-duplicate", name: "Duplication Method", type: "Standard", description: 'On the final boss, duplicate characters may be used.' },
    { id: "boon-combo", name: "Fast Food Combo Meal", type: "Standard", description: 'Combines both the Boss and Character Ban Phase for the session.' },
    { id: "boon-fourstar", name: "Four-Star Impact", type: "Standard", description: 'Character cycling will only cycle out 5-star characters for the session.' },
    { id: "boon-highpotential", name: "High Potential", type: "Standard", description: 'In Boss Ban Phases, increases the maximum in the original RNG values to 35. The Boss Ban Phase will behave in a manner where up to 35 bosses will be banned for the session.' },
    { id: "boon-contraband", name: "Illegal Contraband", type: "Standard", description: 'Enables Gadget usage and environmental mechanisms within boss fights.' },
    { id: "boon-keyhidden", name: "Key To a Hidden Stage", type: "Standard", description: 'After clearing the final boss, the team will have the option to fight the "Tenebrous Papilla" boss. Clearing this additional boss will give you +50 additional Komishells. Deaths/Wipes on this boss will not count against your run.' },
    { id: "boon-lifeinsurance", name: "Life Insurance", type: "Standard", description: 'When collecting twelve total defeated boss drops within a session as a team, it reverts all current Team Wipe Lives to zero.' },
    { id: "boon-moneyback", name: "Money-Back Guarantee", type: "Standard", description: 'If at least 6 weekly bosses in the session are defeated, 2 eliminated characters can be brought back into the Character Randomizer pool based on player choice.' },
    { id: "boon-moonlit", name: "Moonlit Sanctuary", type: "Standard", description: 'Automatically reroll character results when Nod-Krai characters are not rolled with at least one Hydro character. This will not affect the run\'s Pristine status if applicable.' },
    { id: "boon-nochilde", name: "No ‚ÄúChilde‚Äù Policy", type: "Standard", description: 'Guarantees the character "Tartaglia" to be banned in the Initial Character Ban Phases. Guarantees the "Childe" weekly boss to be banned in Boss Ban Phases.' },
    { id: "boon-nonlinear", name: "Non-Linear", type: "Standard", description: 'At the start of the session, rolls all of the session‚Äôs bosses simultaneously. Bosses may be dealt with in any order by player choice.' },
    { id: "boon-notvariable", name: "Not a Variable", type: "Standard", description: 'One random character will remain constant in the Character Randomizer, never being eliminated.' },
    { id: "boon-hardship", name: "Personal Hardship Investment", type: "Standard", description: 'Automatically takes effect in your next session. Those with this boon\'s ownership will fail the entire session if they are defeated once within boss fights. Upon clear, gain 2x Roulette EXP, and this boon becomes a Legendary Boon.' },
    { id: "boon-pretend", name: "Playing Pretend", type: "Standard", description: 'Enables Starlight Resonance - Level 4 to be in effect for the run, regardless of player Unbroken Standing.' },
    { id: "boon-regeneration", name: "Regeneration Module", type: "Standard", description: 'The Death Count will gradually decay over time back to zero. For every 3 boss defeats, 1 point will be taken from the Death Count.' },
    { id: "boon-secondwinds", name: "Second Winds", type: "Standard", description: 'For the session, the team will obtain 3 revive tokens that can be used at any time. Deaths will still contribute to the Death Count.' },
    { id: "boon-highnote", name: "Starting On a High Note", type: "Standard", description: 'The first three bosses in the session are guaranteed to be Azhdaha, Unresolved Chess Game and Lord of Eroded Primal Fire in order. After clearing these bosses, all weekly boss results will be skipped. Gain double Roulette EXP.' },
    { id: "boon-surprise", name: "Surprise Guest", type: "Standard", description: 'Adds one random Local Legend into the Boss Wheel. Defeating the Local Legend will award +50 Komishells and +100 Roulette EXP upon run clear.' },
    { id: "boon-sync", name: "Synchronization Module", type: "Standard", description: 'If a boss is defeated using characters of the same element or region, the Death Count is reduced by 1 point.' },
    { id: "boon-inevitable", name: "The Inevitable", type: "Standard", description: 'The final boss will be guaranteed to be Lord of Eroded Primal Fire, regardless of whether this boss was rolled and defeated/wiped upon previously. Gain double Roulette EXP upon clear.' },
    { id: "boon-wonderland", name: "Wonderland Stage", type: "Standard", description: 'Character use is restricted to Manekin/Manekina only for the session. All weekly boss results will be skipped. Gain double Roulette EXP upon clear.' },
    { id: "boon-saw-nothing", name: "‚ÄùWe saw nothing. Carry on!‚Äù (Legendary)", type: "Legendary", description: 'The first four deaths to occur in the session will not count towards the run\'s Death Count.' },
    { id: "boon-delicious-meal", name: "A Delicious Meal (Legendary)", type: "Legendary", description: 'Non-healing consumables may be used for the entire session (All ATK, Crit, HP, Stamina food buffs).' },
    { id: "boon-jasmine", name: "Jasmine‚Äôs Blessing (Legendary)", type: "Legendary", description: 'Use this at any point in the session to trade places with Jasmine to clear the boss. Jasmine will utilize her C6R5 Chasca for the fight regardless of the rolled result. When the boss is either cleared or wiped upon, Jasmine will exit and trade places with the wielder of this boon.' },
    { id: "boon-premium-spin", name: "Premium Spin Club Free Trial (Legendary)", type: "Legendary", description: 'At the start of the session, gain 2 additional reroll tokens. Defeating weekly bosses grants the team +1 reroll token. Using reroll tokens will not count against the run\'s Pristine status and will not dock points.' },
    { id: "boon-priscilla", name: "Priscilla‚Äôs Blessing (Legendary)", type: "Legendary", description: 'When this boon is active, and the run is a Flawless clear or higher, all party members will gain an additional +1,000 Komishells, +1,000 Roulette EXP, and +50 Unbroken Standing.' }
];

const CHAR_IMAGE_MAP = {
   "Zibai": "images/zibai.png", "Illuga": "images/illuga.png", "Columbina": "images/columbina.png", "Jahoda": "images/jahoda.png", "Durin": "images/durin.png","Aino": "images/aino.png", "Albedo": "images/albedo.png", "Alhaitham": "images/alhaitham.png", "Aloy": "images/alloy.png", "Amber": "images/amber.png", "Arlecchino": "images/arlecchino.png", "Arrataki Itto": "images/itto.png", "Ayaka": "images/ayaka.png", "Ayato": "images/ayato.png", "Baizhu": "images/baizhu.png", "Barbara": "images/barbara.png", "Beidou": "images/beidou.png", "Bennett": "images/bennett.png", "Candace": "images/candace.png", "Chasca": "images/chasca.png", "Charlotte": "images/charlotte.png", "Chevreuse": "images/chevreuse.png", "Childe": "images/tartaglia.png", "Chiori": "images/chiori.png", "Chongyun": "images/chongyun.png", "Citlali": "images/citlali.png", "Clorinde": "images/clorinde.png", "Collei": "images/collei.png", "Cyno": "images/cyno.png", "Dahlia": "images/dahlia.png", "Dehya": "images/dehya.png", "Diluc": "images/diluc.png", "Diona": "images/diona.png", "Dori": "images/dori.png", "Emilie": "images/emilie.png", "Escoffier": "images/escoffier.png", "Eula": "images/eula.png", "Faruzan": "images/faruzan.png", "Fischl": "images/fischl.png", "Flins": "images/flins.png", "Freminet": "images/freminet.png", "Furina": "images/furina.png", "Gaming": "images/gaming.png", "Ganyu": "images/ganyu.png", "Gorou": "images/gorou.png", "Heizou": "images/heizou.png", "Hu Tao": "images/hutao.png", "Iansan": "images/iansan.png", "Ifa": "images/ifa.png", "Ineffa": "images/ineffa.png", "Jean": "images/jean.png", "Kachina": "images/kachina.png", "Kaeya": "images/kaeya.png", "Kazuha": "images/kazuha.png", "Kaveh": "images/kaveh.png", "Keqing": "images/keqing.png", "Kinich": "images/kinich.png", "Kirara": "images/kirara.png", "Klee": "images/klee.png", "Kokomi": "images/kokomi.png", "Kuki Shinobu": "images/kukishinobu.png", "Kujou Sara": "images/sara.png", "Lauma": "images/lauma.png", "Lan yan": "images/lanyan.png", "Layla": "images/layla.png", "Lisa": "images/lisa.png", "Lyney": "images/lyney.png", "Lynette": "images/lynette.png", "Mavuika": "images/mavuika.png", "Mika": "images/mika.png", "Mizuki": "images/mizuki.png", "Mona": "images/mona.png", "Mualani": "images/mualani.png", "Nahida": "images/nahida.png", "Navia": "images/navia.png", "Nefer": "images/nefer.png", "Neuvilette": "images/neuvilette.png", "Nilou": "images/nilou.png", "Ningguang": "images/ningguang.png", "Noelle": "images/noelle.png", "Ororon": "images/ororon.png", "Qiqi": "images/qiqi.png", "Raiden Shogun": "images/raiden.png", "Razor": "images/razor.png", "Rosaria": "images/rosaria.png", "Sayu": "images/sayu.png", "Sethos": "images/sethos.png", "Shenhe": "images/shenhe.png", "Sigewinne": "images/sigewinne.png", "Skirk": "images/skirk.png", "Sucrose": "images/sucrose.png", "Thoma": "images/thoma.png", "Tighnari": "images/tighnari.png", "Traveler": "images/traveler.png", "Varesa": "images/varesa.png", "Venti": "images/venti.png", "Wanderer": "images/wanderer.png", "Wriothesley": "images/wriothesley.png", "Xiao": "images/xiao.png", "Xianyun": "images/xianyun.png", "Xiangling": "images/xiangling.png", "Xilonen": "images/xilonen.png", "Xingqiu": "images/xingqiu.png", "Xinyan": "images/xinyan.png", "Yae Miko": "images/yaemiko.png", "Yanfei": "images/yanfei.png", "Yao Yao": "images/yaoyao.png", "Yelan": "images/yelan.png", "Yoimiya": "images/yoimiya.png", "Yunjin": "images/yunjin.png", "Zhongli": "images/zhongli.png", "DEFAULT_PATH": "images/placeholder.png" 
};

function renderBoons() {
    const masterContainer = document.getElementById('boon-list-master');
    masterContainer.innerHTML = ''; 
    const standardGroup = document.createElement('div');
    standardGroup.className = 'boon-group standard-group';
    standardGroup.innerHTML = '<h3>Standard Boons</h3>';
    const legendaryGroup = document.createElement('div');
    legendaryGroup.className = 'boon-group legendary-group';
    legendaryGroup.innerHTML = '<h3>Legendary Boons</h3>';

    BOONS_DATA.forEach(boon => {
        const itemDiv = document.createElement('div');
        itemDiv.className = `boon-item ${boon.type.toLowerCase()}-boon`;
        const input = document.createElement('input');
        input.type = 'checkbox';
        input.id = boon.id;
        input.name = 'boon';
        input.value = boon.name;
        if (activeBoons.includes(boon.name)) {
            input.checked = true;
        }
        input.onchange = handleBoonChange;
        const label = document.createElement('label');
        label.htmlFor = boon.id;
        label.textContent = boon.name;
        const description = document.createElement('p');
        description.className = 'boon-description';
        description.textContent = boon.description;
        itemDiv.appendChild(input);
        itemDiv.appendChild(label);
        itemDiv.appendChild(description);
        if (boon.type === 'Standard') {
            standardGroup.appendChild(itemDiv);
        } else {
            legendaryGroup.appendChild(itemDiv);
        }
    });

    masterContainer.appendChild(standardGroup);
    masterContainer.appendChild(legendaryGroup);
    handleBoonChange();
}

function handleBoonChange() {
    activeBoons = [];
    boonActivationUses = {}; 
    const checkboxes = document.querySelectorAll('input[name="boon"]:checked');
    checkboxes.forEach(checkbox => {
        const boonName = checkbox.value;
        activeBoons.push(boonName);
        if (boonName === "Delete Button" || boonName === "Jasmine‚Äôs Blessing (Legendary)") {
            boonActivationUses[boonName] = 1;
        }
    });

    const listElement = document.getElementById('active-boons-list').querySelector('p');
    if (activeBoons.length > 0) {
        listElement.innerHTML = `<strong>Active Boons (${activeBoons.length}):</strong> ${activeBoons.join(', ')}`;
    } else {
        listElement.innerHTML = '<strong>Active Boons:</strong> None selected.';
    }
    updateBoonActivationButton(); 
}

function updateBoonActivationButton() {
    const button = document.getElementById('btn-activate-boon');
    const activatableBoons = Object.keys(boonActivationUses).filter(key => boonActivationUses[key] > 0);
    
    if (activatableBoons.length === 1) {
        button.textContent = `Activate Boon: ${activatableBoons[0].split(' ')[0]}`;
        button.disabled = false;
    } else if (activatableBoons.length > 1) {
        button.textContent = `Activate 1 of ${activatableBoons.length} Boons`;
        button.disabled = false;
    } else {
        button.textContent = 'Activate Selected Boon';
        button.disabled = true; 
    }
}

function handleBoonActivation() {
    if (!isExclusionGenerated) {
        alert("Please complete the setup in the left column first: Generate Exclusions.");
        return;
    }
    if (!currentBossToLog) {
        alert("You must roll a boss first before activating a boon.");
        return;
    }
    const rotationSize = parseInt(document.getElementById('boss-rotation-input').value);
    if (rolledBosses.length >= rotationSize) {
        alert("Rotation is already complete.");
        return;
    }

    const activatableBoons = Object.keys(boonActivationUses).filter(key => boonActivationUses[key] > 0);
    if (activatableBoons.length === 0) {
        alert("No activatable boons are currently available.");
        return;
    }

    let boonToActivate;
    if (activatableBoons.length > 1) {
        const boonNames = activatableBoons.map((name, index) => `${index + 1}: ${name}`).join('\n');
        const choice = prompt(`Select a boon to activate by entering the number:\n${boonNames}`);
        const choiceIndex = parseInt(choice) - 1;
        if (isNaN(choiceIndex) || choiceIndex < 0 || choiceIndex >= activatableBoons.length) {
            alert("Invalid selection. Activation cancelled.");
            return;
        }
        boonToActivate = activatableBoons[choiceIndex];
    } else {
        boonToActivate = activatableBoons[0];
    }
    
    let success = false;
    let effectMessage = "";
    let confirmTitle = "";
    const fullBoonData = BOONS_DATA.find(b => b.name === boonToActivate);

    if (boonToActivate === "Delete Button") {
        currentScore += 0;
        const bossEntry = `[Score 0/8] ${currentBossToLog} (Cleared with Delete Button)`;
        rolledBosses.push(bossEntry);
        confirmTitle = `Boon Activated: ${boonToActivate}`;
        effectMessage = `The boss **${currentBossToLog}** has been "insta-killed" and logged as a clear.`;
        success = true;
    } else if (boonToActivate === "Jasmine‚Äôs Blessing (Legendary)") {
        currentScore += 0;
        const bossEntry = `[Score 0/8] ${currentBossToLog} (Cleared with Jasmine's Blessing)`;
        rolledBosses.push(bossEntry);
        confirmTitle = `Legendary Boon Activated: ${boonToActivate}`;
        effectMessage = `Jasmine has traded places and cleared **${currentBossToLog}**.`;
        success = true;
    }
    
    if (success) {
        boonActivationUses[boonToActivate] = 0; 
        currentBossToLog = null; 
        handleNextBossRollAfterActivation();
        updateRolledList();
        updateScoreDisplay();
        updateStatus(rotationSize);
        updateBoonActivationButton(); 
        alert(`${confirmTitle}\n\nEffect: ${fullBoonData.description}\n\nOutcome: ${effectMessage}`);
    }
}

function handleNextBossRollAfterActivation() {
    const rotationSize = parseInt(document.getElementById('boss-rotation-input').value);
    if (rolledBosses.length >= rotationSize) {
        updateCurrentBossDisplay(null);
        showFinalScoreModal(rotationSize);
        return;
    }
    const nextBoss = rollBossSingle(); 
    if (nextBoss) {
        currentBossToLog = nextBoss.name;
        updateCurrentBossDisplay(nextBoss);
    } else {
         updateCurrentBossDisplay(null); 
    }
}

function toggleBoonsDropdown() {
    const wrapper = document.getElementById('boon-list-master-wrapper');
    const icon = document.getElementById('toggle-icon');
    if (wrapper.style.maxHeight === '0px' || wrapper.style.maxHeight === '') {
        wrapper.style.maxHeight = wrapper.scrollHeight + "px";
        icon.textContent = '‚ñ≤';
    } else {
        wrapper.style.maxHeight = '0';
        icon.textContent = '‚ñº';
    }
}

function updateScoreDisplay() {
    const rotationInput = document.getElementById('boss-rotation-input');
    const rotationSize = parseInt(rotationInput.value);
    document.getElementById('score-max').textContent = ` `;
    document.getElementById('score-current').textContent = `Current number of deaths: ${currentScore}`;
}

function updateRolledList() {
    const listElement = document.getElementById('rolled-list');
    listElement.innerHTML = '';
    if (rolledBosses.length === 0) {
        listElement.innerHTML = '<li>No bosses rolled yet.</li>';
        return;
    }
    rolledBosses.forEach(bossEntry => {
        const listItem = document.createElement('li');
        listItem.textContent = bossEntry;
        listElement.appendChild(listItem);
    });
}

function updateBossPoolStatus() {
    document.getElementById('boss-pool-status').textContent = `Total Bosses Available: ${bossPool.length}`;
}

function getBossObjectByName(bossName) {
    return bossesOriginal.find(boss => boss.name === bossName);
}

function updateBossPool(namesToRemove) {
    bossPool = bossPool.filter(boss => !namesToRemove.includes(boss.name));
    updateBossPoolStatus();
}

function displayBossBanList() {
    const listContainer = document.getElementById('boss-ban-list');
    listContainer.innerHTML = '';
    if (bossBanList.length === 0) {
        listContainer.innerHTML = '<p style="color: #0a3a7c; font-weight: normal;">No bosses currently banned.</p>';
        return;
    }
    const ul = document.createElement('ul');
    bossBanList.forEach(name => {
        const listItem = document.createElement('li');
        listItem.textContent = name;
        ul.appendChild(listItem);
    });
    listContainer.appendChild(ul);
}

function resetBossPool() {
    bossPool = [...initialBosses];
    bossBanList.length = 0;
    updateBossPoolStatus();
    displayBossBanList();
}

/**
 * MODIFIED: Run Category Ban now uses manual inputs from the UI
 */
function runCategoryBan() {
    if (!isExclusionGenerated) {
        alert("Please generate the Initial Character Exclusion List first.");
        return;
    }

    const banType = document.getElementById('ban-type-select').value;
    const numToBanInput = parseInt(document.getElementById('manual-ban-count').value);
    const display = document.getElementById('category-ban-display');

    if (isNaN(numToBanInput) || numToBanInput < 1) {
        alert("Please enter a valid number of bans.");
        return;
    }

    if (banType === 'Bosses') {
        const poolForBan = bossPool.filter(boss => !bossBanList.includes(boss.name));
        const actualNumToBan = Math.min(numToBanInput, poolForBan.length);
        const bossesToBan = [];

        if (poolForBan.length === 0) {
            display.textContent = "Ban: Bosses. (No bosses left to ban!)";
        } else {
            while (bossesToBan.length < actualNumToBan) {
                const randomIndex = Math.floor(Math.random() * poolForBan.length);
                const boss = poolForBan.splice(randomIndex, 1)[0];
                bossesToBan.push(boss.name);
                bossBanList.push(boss.name);
            }
            
            if (activeBoons.includes("No ‚ÄúChilde‚Äù Policy") && !bossBanList.includes("Childe")) {
                const childeBoss = getBossObjectByName("Childe");
                if (childeBoss) {
                    bossBanList.push("Childe");
                    bossesToBan.push("Childe");
                }
            }

            updateBossPool(bossesToBan);
            displayBossBanList();
            display.textContent = `Applied: ${bossesToBan.length} Boss Bans.`;
        }
    } else { // Character Bans
        let numToBan = numToBanInput;
        if (activeBoons.includes("Double Down")) {
            numToBan += 8;
        }

        const poolForBan = characterPool.filter(char => !exclusionList.includes(char));
        const actualNumToBan = Math.min(numToBan, poolForBan.length);
        const charsToBan = [];

        if (poolForBan.length === 0) {
            display.textContent = "Ban: Characters. (No characters left to ban!)";
        } else {
            while (charsToBan.length < actualNumToBan) {
                const randomIndex = Math.floor(Math.random() * poolForBan.length);
                const char = poolForBan.splice(randomIndex, 1)[0];
                charsToBan.push(char);
                exclusionList.push(char);
            }
            
            if (activeBoons.includes("No ‚ÄúChilde‚Äù Policy") && !exclusionList.includes("Childe")) {
                exclusionList.push("Childe");
                charsToBan.push("Childe");
            }
            
            updateCharacterPool(charsToBan);
            displayExclusionList();
            display.textContent = `Applied: ${charsToBan.length} Character Bans.`;
        }
    }

    document.getElementById('btn-roll-ban-category').disabled = true;
}

function updateCharacterPoolStatus() {
    document.getElementById('current-pool-status').textContent = `Total Characters Available: ${characterPool.length}`;
}

function updateCharacterPool(namesToRemove) {
    characterPool = characterPool.filter(char => !namesToRemove.includes(char));
    updateCharacterPoolStatus();
}

function displayExclusionList() {
    const listElement = document.getElementById('exclusion-list');
    listElement.innerHTML = ''; 
    if (exclusionList.length === 0) {
        listElement.innerHTML = '<p style="color: #0a3a7c; font-weight: normal;">Enter the number of characters to exclude and click the button.</p>';
        document.getElementById('btn-unban-selected').style.display = 'none';
        return;
    }
    exclusionList.forEach(name => {
        const charSpan = document.createElement('span');
        charSpan.className = 'char-name';
        charSpan.textContent = name;
        charSpan.onclick = () => charSpan.classList.toggle('selected');
        listElement.appendChild(charSpan);
    });
    if (isExclusionGenerated) {
        document.getElementById('btn-unban-selected').style.display = 'inline-block';
    }
}

function resetCharacterPool() {
    characterPool = Array.from(new Set(characters)); 
    exclusionList.length = 0;
    updateCharacterPoolStatus();
    displayExclusionList();
}

function rollBossSingle() {
    if (bossPool.length === 0) return null;
    const randomIndex = Math.floor(Math.random() * bossPool.length);
    const rolledBoss = bossPool[randomIndex];
    if (!activeBoons.includes("Boomerang Effect")) {
        bossPool.splice(randomIndex, 1); 
        updateBossPoolStatus();
    }
    return rolledBoss;
}

function updateCurrentBossDisplay(bossObject) {
    const bossNameElement = document.getElementById('boss-name');
    const parametersArea = document.getElementById('parameters-area');
    if (!bossObject) {
        bossNameElement.textContent = (rolledBosses.length >= parseInt(document.getElementById('boss-rotation-input').value)) ? "Rotation Complete!" : "BOSS POOL EMPTY.";
        parametersArea.innerHTML = "";
        document.getElementById('btn-quick-reroll').style.display = 'none';
        document.getElementById('btn-roll-next').disabled = true;
        return;
    }
    bossNameElement.textContent = bossObject.name;
    const bossObjectFull = getBossObjectByName(bossObject.name);
    if (bossObjectFull && bossObjectFull.description) {
        parametersArea.innerHTML = `<p id="boss-parameters-title">Additional Challenge:</p><p id="boss-parameters-description">${bossObjectFull.description}</p>`;
    } else {
        parametersArea.innerHTML = "";
    }
    bossNameElement.classList.remove('flash');
    void bossNameElement.offsetWidth;
    bossNameElement.classList.add('flash');
    document.getElementById('btn-quick-reroll').style.display = 'inline-block';
    document.getElementById('btn-roll-next').disabled = false;
}

function handleBossRoll() {
    if (!isExclusionGenerated) {
        alert("Please complete the setup in the left column first.");
        return;
    }
    const rotationSize = parseInt(document.getElementById('boss-rotation-input').value);
    if (!currentBossToLog) {
        const firstBoss = rollBossSingle();
        if (firstBoss) {
            currentBossToLog = firstBoss.name;
            updateCurrentBossDisplay(firstBoss);
            document.getElementById('btn-roll-next').textContent = 'Log Run & Roll Next Boss';
        }
        updateStatus(rotationSize);
        return; 
    }
    const selectedScore = parseInt(document.querySelector('input[name="penalty_score"]:checked').value);
    const rollCountInput = document.getElementById('boss-roll-count');
    let rollsRequested = parseInt(rollCountInput.value);
    rollsRequested = (isNaN(rollsRequested) || rollsRequested < 1) ? 1 : rollsRequested;
    currentScore += selectedScore;
    rolledBosses.push(`[Score ${selectedScore}/8] ${currentBossToLog}`);
    currentBossToLog = null;
    if (rolledBosses.length >= rotationSize) {
        updateCurrentBossDisplay(null);
        showFinalScoreModal(rotationSize);
        return;
    }
    let lastRolledBossObject = null;
    const actualRolls = Math.min(rollsRequested, rotationSize - rolledBosses.length);
    for (let i = 0; i < actualRolls; i++) {
        const rolledBoss = rollBossSingle(); 
        if (!rolledBoss) break;
        if (i < actualRolls - 1) { 
            currentScore += selectedScore;
            rolledBosses.push(`[Score ${selectedScore}/8] ${rolledBoss.name}`);
        } else {
            lastRolledBossObject = rolledBoss;
        }
    }
    if (lastRolledBossObject) {
        currentBossToLog = lastRolledBossObject.name;
        updateCurrentBossDisplay(lastRolledBossObject);
    }
    updateRolledList();
    updateScoreDisplay();
    updateStatus(rotationSize);
}

function rerollBoss() {
    if (!isExclusionGenerated || !currentBossToLog) return;
    const oldBossName = currentBossToLog;
    const newBoss = rollBossSingle();
    if (!newBoss) return;
    updateCurrentBossDisplay(newBoss);
    if (!activeBoons.includes("Boomerang Effect")) {
        const oldBossObject = getBossObjectByName(oldBossName);
        if (oldBossObject) {
            bossPool.push(oldBossObject);
            updateBossPoolStatus();
        }
    }
    currentBossToLog = newBoss.name; 
}

function resetRotationAndReroll() {
    if (!isExclusionGenerated) return;
    resetBossRotation();
    const firstBoss = rollBossSingle();
    if (firstBoss) {
        currentBossToLog = firstBoss.name;
        updateCurrentBossDisplay(firstBoss);
        document.getElementById('btn-roll-next').textContent = 'Log Run & Roll Next Boss';
    }
}

function resetBossRotation() {
    rolledBosses.length = 0;
    currentScore = 0;
    currentBossToLog = null;
    updateRolledList();
    updateScoreDisplay();
    updateStatus(document.getElementById('boss-rotation-input').value);
}

function randomizeCharacters(count) {
    if (!isExclusionGenerated) {
        alert("Please complete setup first.");
        return;
    }
    currentRolledSquad.length = 0;
    const display = document.getElementById('character-display');
    display.innerHTML = '';
    const selectionMessage = document.getElementById('selection-message');
    let poolToRollFrom = [...characterPool]; 
    if (activeBoons.includes("Four-Star Impact")) {
        poolToRollFrom = poolToRollFrom.filter(char => !fiveStarCharacters.includes(char));
    }
    const actualRollCount = Math.min(count, poolToRollFrom.length);
    if (actualRollCount === 0) {
        display.innerHTML = '<p style="color: red;">Error: Character pool is empty.</p>';
        return;
    }
    let tempPool = [...poolToRollFrom]; 
    for (let i = 0; i < actualRollCount; i++) {
        const randomIndex = Math.floor(Math.random() * tempPool.length);
        currentRolledSquad.push(tempPool.splice(randomIndex, 1)[0]);
    }
    currentRolledSquad.forEach(name => {
        const charCard = document.createElement('div');
        charCard.className = 'character-card';
        const imgContainer = document.createElement('div');
        imgContainer.className = 'char-image-placeholder';
        const imgElement = document.createElement('img');
        imgElement.src = CHAR_IMAGE_MAP[name] || CHAR_IMAGE_MAP["DEFAULT_PATH"];
        imgContainer.appendChild(imgElement);
        const charSpan = document.createElement('span');
        charSpan.className = 'char-name';
        charSpan.textContent = name;
        charCard.onclick = () => charCard.classList.toggle('selected');
        charCard.appendChild(charSpan);
        charCard.appendChild(imgContainer); 
        display.appendChild(charCard);
    });
    document.getElementById('btn-roll-chars').style.display = 'none';
    document.getElementById('btn-reroll-chars').style.display = 'inline-block';
    document.getElementById('btn-confirm-usage').disabled = false;
}

function rerollCharacters() {
    randomizeCharacters(8); 
}

function confirmUsedCharacters() {
    const selectedChars = Array.from(document.querySelectorAll('#character-display .character-card.selected .char-name')).map(el => el.textContent);
    if (selectedChars.length < 1) return;
    let charsToEliminate = selectedChars;
    if (activeBoons.includes("Four-Star Impact")) {
        charsToEliminate = selectedChars.filter(name => !FOUR_STAR_CHARS.includes(name));
    }
    if (charsToEliminate.length > 0) updateCharacterPool(charsToEliminate);
    currentRolledSquad.length = 0;
    document.getElementById('character-display').innerHTML = '<p>Usage confirmed.</p>';
    document.getElementById('btn-roll-chars').style.display = 'inline-block';
    document.getElementById('btn-reroll-chars').style.display = 'none';
    document.getElementById('btn-confirm-usage').disabled = true;
}

function handleUnbanSelected() {
    const listElement = document.getElementById('exclusion-list');
    const selectedSpans = Array.from(listElement.querySelectorAll('.char-name.selected'));
    if (selectedSpans.length === 0) return;
    const namesToUnban = selectedSpans.map(span => span.textContent);
    const newExclusionList = exclusionList.filter(name => !namesToUnban.includes(name));
    exclusionList.length = 0; 
    exclusionList.push(...newExclusionList); 
    namesToUnban.forEach(name => { if (!characterPool.includes(name)) characterPool.push(name); });
    displayExclusionList();
    updateCharacterPoolStatus();
}

function handleGenerateExclusions() {
    const countInput = document.getElementById('exclusion-count-input');
    const count = parseInt(countInput.value);
    if (isExclusionGenerated) return; 
    if (isNaN(count) || count < 1 || count > characterPool.length) return;
    generateExclusionList(count); 
}

function generateExclusionList(count) {
    let tempPool = [...characterPool];
    const newlyExcluded = [];
    for (let i = 0; i < count; i++) {
        const randomIndex = Math.floor(Math.random() * tempPool.length);
        const char = tempPool.splice(randomIndex, 1)[0];
        newlyExcluded.push(char);
        exclusionList.push(char);
    }
    if (activeBoons.includes("No ‚ÄúChilde‚Äù Policy") && !exclusionList.includes("Childe")) {
        if (characterPool.includes("Childe")) exclusionList.push("Childe");
    }
    updateCharacterPool(newlyExcluded);
    displayExclusionList();
    isExclusionGenerated = true;
    document.getElementById('btn-generate-exclusions').disabled = true;
    document.getElementById('btn-roll-next').disabled = false;
    document.getElementById('btn-roll-chars').disabled = false;
    document.getElementById('btn-roll-ban-category').disabled = false; 
    document.getElementById('boss-name').textContent = "Ready! Click 'Roll Next Boss' to begin.";
    document.getElementById('category-ban-display').textContent = 'Enter ban amount and click "Apply Bans".';
    if (activeBoons.includes("Fast Food Combo Meal")) runCategoryBan();
}

function resetCharacterLists() {
    resetCharacterPool();
    currentRolledSquad.length = 0;
    document.getElementById('btn-roll-chars').style.display = 'inline-block';
    document.getElementById('btn-reroll-chars').style.display = 'none';
    document.getElementById('btn-confirm-usage').disabled = true;
    if (isExclusionGenerated) setInitialGameLocks();
}

function showFinalScoreModal(rotationSize) {
    const maxPossibleScore = rotationSize * 8;
    const percentage = ((currentScore / maxPossibleScore) * 100).toFixed(1);
    document.getElementById('modal-score-current').textContent = currentScore;
    document.getElementById('modal-score-max').textContent = maxPossibleScore;
    document.getElementById('modal-score-percentage').textContent = `${percentage}% of Max Score`;
    document.getElementById('final-score-modal').classList.add('open');
}

function closeFinalScoreModal() {
    document.getElementById('final-score-modal').classList.remove('open');
    resetRotationAndReroll();
}

function updateStatus(rotationSize) {
    document.getElementById('rotation-status').textContent = `${rolledBosses.length}/${rotationSize} bosses done`;
}

function setInitialGameLocks() {
    isExclusionGenerated = false;
    document.getElementById('btn-roll-next').disabled = true;
    document.getElementById('btn-quick-reroll').style.display = 'none'; 
    document.getElementById('btn-roll-chars').disabled = true;
    document.getElementById('btn-roll-ban-category').disabled = true; 
    document.getElementById('btn-generate-exclusions').disabled = false;
    document.getElementById('boss-name').textContent = "üîí Locked: Complete setup first.";
    document.getElementById('category-ban-display').textContent = 'Setup Step: Generate Exclusions to unlock bans.';
    updateBoonActivationButton();
}

function resetEntireGame() {
    if (!window.confirm("Are you sure?")) return;
    resetBossRotation();
    resetBossPool();
    resetCharacterLists();
    activeBoons = [];
    document.querySelectorAll('input[name="boon"]').forEach(checkbox => checkbox.checked = false);
    handleBoonChange();
    setInitialGameLocks();
    initializeApp();
}

function initializeApp() {
    bossesOriginal = [...initialBosses];
    resetBossPool();
    resetCharacterPool(); 
    const input = document.getElementById('boss-rotation-input');
    input.value = 12; 
    updateStatus(input.value);
    updateRolledList(); 
    updateScoreDisplay(); 
    renderBoons(); 
    setInitialGameLocks();
    document.getElementById('exclusion-count-input').max = characterPool.length;
    document.getElementById('boss-roll-count').max = 12;
}

document.addEventListener('DOMContentLoaded', initializeApp);
</script>

</body>
</html>